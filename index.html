<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Code Rivals - C++ Challenge</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    body {
        margin: 0;
        padding: 0;
        background: radial-gradient(circle at center, #001f3f, #000);
        font-family: 'Orbitron', sans-serif;
        color: #00ccff;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh; /* Use min-height for content adaptability */
        width: 100vw;
        overflow-x: hidden; /* Prevent horizontal scroll */
        overflow-y: auto; /* Allow vertical scroll for content */
        font-family: 'Inter', sans-serif; /* Use Inter for general text */
    }

    h1 {
        text-shadow: 0 0 10px #00ccff;
        margin: 20px 0 10px;
        font-size: 32px;
        font-family: 'Orbitron', sans-serif; /* Keep Orbitron for titles */
    }

    .game-container {
        position: relative;
        width: 90%; /* Responsive width */
        max-width: 900px; /* Increased max width */
        height: 650px; /* Increased height */
        border: 2px solid #00ccff;
        border-radius: 20px;
        box-shadow: 0 0 30px #00ccff inset;
        background-color: rgba(0, 0, 50, 0.9);
        overflow: hidden;
        margin-top: 10px;
    }

    /* New: Reusable class for the primary button style */
    .primary-btn {
        padding: 8px 16px;
        background-color: #001f3f;
        border: 2px solid #00ccff;
        color: #00ccff;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 10px #00ccff;
        border-radius: 8px;
        transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
    }

    .primary-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 15px #00ff00;
        background-color: #003f6f; /* Slightly darker on hover */
    }


    /* Shared button style for back button (now uses primary-btn) */
    #backToLobbyBtn, #soloBackToLobbyBtn, .back-to-mode-selection-btn, .back-to-lobbies-btn {
        position: absolute;
        top: 10px;
        left: 10px; /* Positioned on the left side */
    }

    /* Specific styling for the 'Ready Up!' button in singleLobbyView header */
    #readyToggleBtn {
        position: relative; /* Override absolute positioning if inherited */
        /* Keep other styles from .primary-btn */
    }

    /* Specific styling for the 'Create New Lobby' button in lobby-list-container header */
    .lobby-header .primary-btn { /* Target specifically the create lobby button */
        position: relative; /* Override absolute positioning if inherited */
        /* Keep other styles from .primary-btn */
        margin-right: 0; /* Adjust margin if needed */
        margin-bottom: 0;
    }

    .player-circle {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }

    .player {
        position: absolute;
        width: 100px;
        text-align: center;
        transform: translate(-50%, -50%);
    }

    .player .name {
        font-weight: bold;
        font-size: 16px;
    }

    .player .name.active {
        color: yellow;
        text-shadow: 0 0 10px yellow;
    }

    .player .name.correct {
        color: lime;
        text-shadow: 0 0 10px lime;
    }

    .player .name.wrong {
        color: red;
        text-shadow: 0 0 10px red;
    }

    .player .lives {
        font-size: 12px;
    }

    #timer {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 48px;
        text-shadow: 0 0 10px #00ccff;
    }

    #questionBox {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0,0,50,0.7);
        padding: 20px;
        border: 2px solid #00ccff;
        border-radius: 10px;
        box-shadow: 0 0 10px #00ccff;
        width: 90%; /* Responsive width */
        max-width: 700px; /* Max width for question box */
        text-align: center;
        box-sizing: border-box; /* Include padding in width */
    }

    #questionBox input[type="text"] {
        padding: 10px;
        font-size: 16px;
        width: calc(70% - 15px); /* Adjusted width */
        background-color: black;
        color: #00ccff;
        border: 1px solid #00ccff;
        border-radius: 5px;
        margin-right: 10px;
        box-sizing: border-box;
    }

    #questionBox button {
        padding: 10px 20px;
        background-color: #001f3f;
        border: 2px solid #00ccff;
        color: #00ccff;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 10px #00ccff;
        border-radius: 5px;
        transition: background-color 0.2s, box-shadow 0.2s;
    }
    #questionBox button:hover {
        background-color: #003f6f;
        box-shadow: 0 0 15px #00ff00;
    }

    .replay-button {
        margin-top: 20px;
        display: none;
    }

    #leaderboard, #globalLeaderboard {
        margin-top: 20px;
        width: 95%; /* Expanded width */
        max-width: 900px;
        background-color: rgba(0,0,0,0.85);
        border: 3px solid #00ccff;
        border-radius: 20px;
        padding: 10px;
        color: #00ccff;
        font-size: 14px;
        font-weight: bold;
        text-align: center;
        box-shadow: 0 0 15px #00ccff;
        height: auto;
        margin-bottom: 20px; /* Added margin */
    }

    #leaderboard table, #globalLeaderboard table {
        width: 100%;
        border-collapse: collapse;
        font-family: 'Orbitron', sans-serif;
    }

    #leaderboard th, #leaderboard td, #globalLeaderboard th, #globalLeaderboard td {
        padding: 12px 10px;
        border: 1px solid #00ccff;
    }

    #leaderboard thead, #globalLeaderboard thead {
        background-color: #000;
        color: #00ccff;
        font-size: 18px;
        text-shadow: 0 0 5px #00ccff;
    }

    #leaderboard tbody tr:nth-child(odd), #globalLeaderboard tbody tr:nth-child(odd) {
        background-color: rgba(0, 0, 50, 0.6);
    }

    #leaderboard tbody tr:nth-child(even), #globalLeaderboard tbody tr:nth-child(even) {
        background-color: rgba(0, 0, 100, 0.4);
    }

    #leaderboard tbody td, #globalLeaderboard tbody td {
        font-size: 16px;
    }

    /* Styles for Game Mode Selection */
    #gameModeSelection {
        display: none; /* Hidden by default, shown after login */
        flex-direction: column; /* Changed to column for better mobile layout */
        align-items: center;
        background-color: rgba(0,0,50,0.9);
        border: 2px solid #00ccff;
        border-radius: 20px;
        padding: 20px;
        width: 90%;
        max-width: 600px;
        text-align: center;
        box-shadow: 0 0 20px #00ccff;
        margin-top: 50px;
        gap: 20px;
    }

    .game-mode-box {
        width: 100%; /* Full width within container */
        background-color: #001f3f;
        border: 2px solid #00ccff;
        border-radius: 15px;
        padding: 30px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .game-mode-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 0 25px #00ccff;
    }

    .game-mode-box h3 {
        margin-top: 0;
        color: #00ccff;
        text-shadow: 0 0 8px #00ccff;
        font-family: 'Orbitron', sans-serif;
    }

    #gameUI {
        display: none;
        flex-direction: column;
        align-items: center;
        margin-top: 10px;
        flex-grow: 1;
    }

    /* New styles for chat box */
    .main-content-wrapper {
        display: none;
        flex-direction: row; /* Default to row for wider screens */
        gap: 20px;
        width: 95%; /* Adjust width to fit content */
        max-width: 1200px; /* Max width for the wrapper */
        justify-content: center;
        align-items: stretch;
        flex-grow: 1;
        min-height: 80vh; /* Occupy significant vertical space */
        flex-wrap: wrap; /* Allow wrapping for smaller screens */
    }
    @media (max-width: 992px) { /* Adjust for tablet/mobile */
        .main-content-wrapper {
            flex-direction: column; /* Stack vertically on smaller screens */
            align-items: center;
        }
        .game-container, #chatBox, #soloChallengeUI {
            width: 95%; /* Wider on smaller screens */
            max-width: 650px; /* Adjust max-width */
        }
    }


    #chatBox {
        background-color: rgba(0, 0, 50, 0.9);
        border: 2px solid #00ccff;
        border-radius: 10px;
        box-shadow: 0 0 20px #00ccff;
        width: 300px; /* Fixed width for chat */
        height: auto; /* Allow height to adjust */
        min-height: 300px; /* Minimum height for chat box */
        margin-top: 10px;
        padding: 15px;
        display: flex;
        flex-direction: column;
    }

    #chatMessages {
        flex-grow: 1;
        overflow-y: auto;
        border: 1px solid #00ccff;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
        background-color: rgba(0, 0, 0, 0.5);
        color: #00ccff;
        font-size: 14px;
        word-wrap: break-word;
        min-height: 150px; /* Ensure chat messages area has min height */
    }

    #chatInput {
        padding: 8px;
        font-size: 14px;
        background-color: black;
        color: #00ccff;
        border: 1px solid #00ccff;
        border-radius: 5px;
        width: calc(100% - 16px);
        margin-bottom: 5px;
    }

    #sendChatBtn {
        padding: 8px 15px;
        background-color: #001f3f;
        border: 2px solid #00ccff;
        color: #00ccff;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 10px #00ccff;
        border-radius: 5px;
        width: 100%;
        transition: background-color 0.2s, box-shadow 0.2s;
    }
    #sendChatBtn:hover {
        background-color: #003f6f;
        box-shadow: 0 0 15px #00ff00;
    }

    /* Solo Challenge UI Styles */
    #soloChallengeUI {
        display: none;
        flex-direction: column;
        align-items: center;
        background-color: rgba(0,0,50,0.9);
        border: 2px solid #00ccff;
        border-radius: 20px;
        box-shadow: 0 0 30px #00ccff inset;
        padding: 20px;
        width: 90%; /* Responsive width */
        max-width: 900px; /* Same max-width as game-container for consistency */
        min-height: 650px; /* Adjusted min-height for content */
        margin-top: 10px;
        position: relative;
        flex-grow: 1;
        box-sizing: border-box;
    }

    #soloChallengeUI h2 {
        color: #00ccff;
        text-shadow: 0 0 8px #00ccff;
        margin-top: 0;
        font-family: 'Orbitron', sans-serif;
    }

    #soloProblemDescription {
        background-color: rgba(0,0,0,0.7);
        border: 1px solid #00ccff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        width: calc(100% - 30px);
        min-height: 80px;
        overflow-y: auto;
        font-size: 16px;
        box-sizing: border-box;
    }

    #soloCodeEditor {
        width: calc(100% - 20px);
        height: 200px;
        background-color: #000;
        color: #00ff00; /* Green text for code editor */
        border: 1px solid #00ccff;
        border-radius: 5px;
        padding: 10px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        resize: vertical;
        margin-bottom: 15px;
        box-sizing: border-box;
    }

    #soloChallengeButtons {
        display: flex;
        flex-wrap: wrap; /* Allow buttons to wrap */
        justify-content: center;
        gap: 15px;
        margin-bottom: 15px;
    }

    #soloChallengeButtons button {
        padding: 12px 25px;
        background-color: #001f3f;
        border: 2px solid #00ccff;
        color: #00ccff;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 10px #00ccff;
        border-radius: 8px;
        transition: background-color 0.2s, box-shadow 0.2s;
    }

    #soloChallengeButtons button:hover:not(:disabled) {
        background-color: #003f6f;
        box-shadow: 0 0 15px #00ff00;
    }

    #soloChallengeButtons button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }

    #soloLoadingIndicator {
        display: none;
        text-align: center;
        margin-top: 10px;
        font-size: 18px;
        color: yellow;
    }

    #soloResult {
        background-color: rgba(0,0,0,0.7);
        border: 1px solid #00ccff;
        border-radius: 8px;
        padding: 15px;
        width: calc(100% - 30px);
        min-height: 80px;
        overflow-y: auto;
        font-size: 14px;
        white-space: pre-wrap;
        box-sizing: border-box;
    }


    /* Custom Modal for Alerts */
    .custom-modal {
        display: none;
        position: fixed;
        z-index: 20;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .custom-modal-content {
        background-color: rgba(0,0,50,0.95);
        margin: auto;
        padding: 30px;
        border: 3px solid #00ccff;
        border-radius: 15px;
        width: 90%; /* Responsive width */
        max-width: 400px;
        text-align: center;
        box-shadow: 0 0 25px #00ccff;
        transform: scale(0.95);
        animation: modalFadeIn 0.3s forwards;
        color: #fff;
    }

    .custom-modal-content h3 {
        color: #00ccff;
        text-shadow: 0 0 10px #00ccff;
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 24px;
        font-family: 'Orbitron', sans-serif;
    }

    .custom-modal-content p {
        font-size: 16px;
        margin-bottom: 25px;
        line-height: 1.5;
    }

    .custom-modal-content button {
        background-color: #001f3f;
        border: 2px solid #00ccff;
        color: #00ccff;
        padding: 10px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 0 10px #00ccff;
        transition: background-color 0.2s, box-shadow 0.2s;
    }

    .custom-modal-content button:hover {
        background-color: #003f6f;
        box-shadow: 0 0 15px #00ff00;
    }

    @keyframes modalFadeIn {
        from { opacity: 0; transform: scale(0.8); }
        to { opacity: 1; transform: scale(1); }
    }

    /* Login/Signup Forms */
    #authContainer {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: rgba(0,0,50,0.9);
        border: 2px solid #00ccff;
        border-radius: 20px;
        padding: 30px;
        width: 90%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 0 25px #00ccff;
        margin-top: 50px;
    }

    #authContainer h2 {
        color: #00ccff;
        text-shadow: 0 0 8px #00ccff;
        margin-top: 0;
        margin-bottom: 25px;
        font-family: 'Orbitron', sans-serif;
    }

    #authContainer input[type="text"],
    #authContainer input[type="password"] {
        width: calc(100% - 20px);
        padding: 12px;
        margin-bottom: 15px;
        background-color: black;
        color: #00ccff;
        border: 1px solid #00ccff;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box;
    }

    #authContainer button {
        width: 100%;
        padding: 12px;
        background-color: #001f3f;
        border: 2px solid #00ccff;
        color: #00ccff;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 10px #00ccff;
        border-radius: 8px;
        font-size: 18px;
        transition: background-color 0.2s, box-shadow 0.2s;
        margin-bottom: 10px;
    }

    #authContainer button:hover {
        background-color: #003f6f;
        box-shadow: 0 0 15px #00ff00;
    }

    #authSwitch {
        color: #00ccff;
        text-decoration: underline;
        cursor: pointer;
        font-size: 14px;
        margin-top: 15px;
        transition: color 0.2s;
    }
    #authSwitch:hover {
        color: #00ff00;
    }

    /* Logout Button in Main UI (will be shown after login) */
    #logoutBtn {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 8px 16px;
        background-color: #a00000;
        border: 2px solid #ff0000;
        color: #fff;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 10px #ff0000;
        z-index: 10;
        border-radius: 8px;
        display: none;
        transition: background-color 0.2s, box-shadow 0.2s;
    }
    #logoutBtn:hover {
        background-color: #cc0000;
        box-shadow: 0 0 15px #ff6666;
    }

    #welcomeMessage {
        color: #fff;
        font-size: 18px;
        margin-top: 10px;
        display: none;
        text-align: center;
        margin-bottom: 20px;
    }

    /* New Lobby Styles */
    .lobby-list-container {
        display: none;
        flex-direction: column;
        align-items: center;
        background-color: rgba(0,0,50,0.9);
        border: 2px solid #00ccff;
        border-radius: 20px;
        padding: 20px;
        width: 90%;
        max-width: 800px;
        text-align: center;
        box-shadow: 0 0 20px #00ccff;
        margin-top: 50px;
        overflow-y: auto;
        max-height: 80vh;
    }

    .lobby-list-container h2 {
        color: #00ccff;
        text-shadow: 0 0 8px #00ccff;
        margin-top: 0;
        margin-bottom: 20px;
        font-family: 'Orbitron', sans-serif;
    }

    .lobby-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        width: 100%;
        padding: 10px;
    }

    .lobby-card {
        background-color: #001f3f;
        border: 2px solid #00ccff;
        border-radius: 15px;
        padding: 20px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        text-align: left;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 120px; /* Adjusted to min-height */
    }

    .lobby-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0 25px #00ccff;
    }

    .lobby-card h3 {
        margin: 0 0 10px 0;
        color: #00ccff;
        text-shadow: 0 0 5px #00ccff;
        font-size: 1.2em;
    }

    .lobby-card p {
        margin: 5px 0;
        font-size: 0.9em;
    }

    .lobby-card .join-btn {
        padding: 8px 15px;
        background-color: #004d40;
        border: 2px solid #00ccff;
        color: #00ccff;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 10px #00ccff;
        border-radius: 8px;
        transition: background-color 0.2s, box-shadow 0.2s;
        margin-top: 10px;
        align-self: flex-end;
    }

    .lobby-card .join-btn:hover {
        background-color: #00645a;
        box-shadow: 0 0 15px #00ff00;
    }

    .lobby-card.full {
        opacity: 0.7;
        cursor: not-allowed;
        background-color: #333;
    }

    .lobby-card.full .join-btn {
        background-color: #666;
        border-color: #999;
        cursor: not-allowed;
        box-shadow: none;
    }

    .lobby-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        margin-bottom: 20px;
        flex-wrap: wrap; /* Allow wrap for title and buttons */
    }

    .lobby-header button {
        position: relative; /* Remove absolute positioning from here */
        top: auto;
        left: auto;
        margin-right: 10px; /* Adjust spacing between buttons */
        margin-bottom: 10px; /* Space when wrapped */
    }
    .lobby-header h2 {
        flex-grow: 1; /* Allow title to take available space */
        text-align: center;
        margin-bottom: 10px;
    }

    #startGameButton {
        padding: 12px 25px;
        background-color: #008000;
        border: 2px solid #00ff00;
        color: #fff;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 10px #00ff00;
        border-radius: 8px;
        transition: background-color 0.2s, box-shadow 0.2s;
        margin-top: 20px;
    }

    #startGameButton:hover:not(:disabled) {
        background-color: #00b300;
        box-shadow: 0 0 15px #00ff00;
    }

    #startGameButton:disabled {
        cursor: not-allowed;
        opacity: 0.5;
        background-color: #555;
        border-color: #888;
        box-shadow: none;
    }

    #currentLobbyInfo {
        margin-top: 10px;
        font-size: 1.1em;
        color: #fff;
        text-shadow: 0 0 5px #00ccff;
        display: none;
    }

    .player-status {
        font-size: 0.9em;
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 10px;
        margin-left: 10px;
    }

    .player-status.ready {
        background-color: #00ff00;
        color: #003300;
    }

    .player-status.not-ready {
        background-color: #ff0000;
        color: #330000;
    }

    /* Styles for the Create Lobby Modal */
    #createLobbyModal {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 20;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.8);
        justify-content: center;
        align-items: center;
    }

    #createLobbyModal .custom-modal-content {
        padding: 25px;
        max-width: 450px;
    }

    #createLobbyModal .custom-modal-content h3 {
        margin-bottom: 15px;
        font-size: 22px;
    }

    #createLobbyModal .custom-modal-content label {
        display: block;
        text-align: left;
        margin-bottom: 8px;
        color: #00ccff;
        font-size: 15px;
    }

    #createLobbyModal .custom-modal-content input[type="text"],
    #createLobbyModal .custom-modal-content select {
        width: calc(100% - 20px);
        padding: 10px;
        margin-bottom: 20px;
        background-color: black;
        color: #00ccff;
        border: 1px solid #00ccff;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box;
    }
    
    /* Specific styling for select dropdown arrow */
    #createLobbyModal .custom-modal-content select {
        appearance: none; /* Remove default browser arrow */
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url('data:image/svg+xml;utf8,<svg fill="%2300ccff" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
    }


    /* Apply primary-btn style to these modal buttons too */
    #createLobbyModal .custom-modal-content button {
        width: auto; /* Allow buttons to size based on content */
        min-width: 120px;
        margin: 0 10px; /* Spacing between buttons */
        /* Removed duplicate button styling, now inherits from .primary-btn */
        padding: 10px 25px; /* Adjust padding for modal buttons if different */
        background-color: #001f3f; /* Keep specific background for modal buttons if desired, or remove to inherit */
        border: 2px solid #00ccff;
        color: #00ccff;
        font-weight: bold;
        box-shadow: 0 0 10px #00ccff;
        border-radius: 8px;
    }

    #createLobbyModal .custom-modal-content button:hover {
        background-color: #003f6f;
        box-shadow: 0 0 15px #00ff00;
    }


    .modal-buttons {
        display: flex;
        justify-content: center;
        margin-top: 10px;
    }
</style>
</head>
<body>
<h1>Code Rivals</h1>

<button id="logoutBtn" onclick="logout()">Logout</button>
<div id="welcomeMessage"></div>

<div id="authContainer">
    <h2 id="authTitle">Login</h2>
    <input type="text" id="usernameInput" placeholder="Username" autocomplete="username">
    <input type="password" id="passwordInput" placeholder="Password" autocomplete="current-password">
    <button id="authSubmitBtn" onclick="authAction()">Login</button>
    <div id="authSwitch" onclick="toggleAuthMode()">Don't have an account? Sign Up</div>
</div>


<div id="gameModeSelection">
    <h2>Choose Your Game Mode</h2>
    <div class="game-mode-box" onclick="showLobbyList('4v4-qna')">
        <h3>4v4 Q&A</h3>
        <p>Compete with up to 4 players in a fast-paced Q&A challenge.</p>
    </div>
    <div class="game-mode-box" onclick="showLobbyList('1v1-fill-in-blanks')">
        <h3>1v1 Fill in the Blanks</h3>
        <p>A head-to-head battle, filling in missing code for C++ beginners.</p>
    </div>
    <div class="game-mode-box" onclick="selectGameMode('solo-coding-challenge')">
        <h3>Solo Coding Challenge</h3>
        <p>Improve your skills by solving C++ problems, evaluated by AI.</p>
    </div>
</div>

<div id="lobbyListContainer" class="lobby-list-container">
    <div class="lobby-header">
        <button class="back-to-mode-selection-btn primary-btn" onclick="backToModeSelection()">Back to Mode Select</button>
        <h2 id="lobbyListTitle">Available Lobbies</h2>
        <button class="primary-btn" onclick="createNewLobby()">Create New Lobby</button>
    </div>
    <div id="lobbiesGrid" class="lobby-grid">
        </div>
</div>

<div id="singleLobbyView" class="lobby-list-container">
    <div class="lobby-header">
        <button class="back-to-lobbies-btn primary-btn" onclick="leaveLobby()">Leave Lobby</button>
        <h2 id="currentLobbyTitle"></h2>
        <button id="readyToggleBtn" class="primary-btn" onclick="toggleReady()">Ready Up!</button>
    </div>
    <p id="currentLobbyInfo">Lobby ID: <span id="displayLobbyId"></span> | Players: <span id="displayPlayerCount">0</span>/<span id="displayMaxPlayers">0</span> | Status: <span id="displayLobbyStatus"></span></p>
    <div id="lobbyPlayersDisplay" class="lobby-grid">
        </div>
    <button id="startGameButton" onclick="startGame()" disabled>Start Game</button>
</div>


<div class="main-content-wrapper">
    <div id="gameUI">
        <div class="game-container">
            <button id="backToLobbyBtn" class="primary-btn" onclick="leaveGame()">Back to Lobbies</button>
            <div class="player-circle" id="playerCircle"></div>
            <div id="timer">30</div>
            <div id="questionBox">
                <p id="question">Loading...</p>
                <input type="text" id="answerInput" placeholder="Your answer here" />
                <button id="submitAnswerBtn" onclick="submitAnswer()">Submit</button>
            </div>
        </div>

        <div id="leaderboard">
            <h2>Current Round Leaderboard</h2>
            <table>
                <thead>
                    <tr><th>Rank</th><th>Player</th><th>ELO</th><th>Accuracy</th></tr>
                </thead>
                <tbody id="leaderboardBody"></tbody>
            </table>
        </div>

        <div id="globalLeaderboard">
            <h2>Global Leaderboard (All Players)</h2>
            <table>
                <thead>
                    <tr><th>Rank</th><th>Player</th><th>ELO</th><th>Accuracy</th></tr>
                </thead>
                <tbody id="globalLeaderboardBody"></tbody>
            </table>
        </div>
        <div class="replay-button" id="replayButton">
            <button onclick="replayGame()">Replay</button>
        </div>
    </div>

    <div id="soloChallengeUI">
        <button id="soloBackToLobbyBtn" class="primary-btn" onclick="leaveSoloChallenge()">Back to Mode Select</button>
        <h2>Solo Coding Challenge - Stage <span id="soloCurrentStage">1</span></h2>
        <div id="soloProblemDescription"></div>
        <textarea id="soloCodeEditor" placeholder="Write your C++ code here..."></textarea>
        <div id="soloChallengeButtons">
            <button id="soloPrevStageBtn" class="primary-btn" onclick="previousSoloStage()" disabled>Previous Stage</button>
            <button class="primary-btn" onclick="submitSoloCode()">Run Code</button>
            <button id="soloNextStageBtn" class="primary-btn" onclick="nextSoloStage()" disabled>Next Stage</button>
        </div>
        <div id="soloLoadingIndicator">Evaluating code...</div>
        <div id="soloResult"></div>
    </div>


    <div id="chatBox">
        <h3>Lobby Chat</h3>
        <div id="chatMessages"></div>
        <input type="text" id="chatInput" placeholder="Type your message..." />
        <button id="sendChatBtn" onclick="sendMessage()">Send</button>
    </div>
</div>

<div id="customModal" class="custom-modal">
    <div class="custom-modal-content">
        <h3 id="modalTitle"></h3>
        <p id="modalMessage"></p>
        <button onclick="closeModal()">OK</button>
    </div>
</div>

<div id="createLobbyModal" class="custom-modal">
    <div class="custom-modal-content">
        <h3>Create New Lobby</h3>
        <label for="new-lobby-name">Lobby Name:</label>
        <input type="text" id="new-lobby-name" placeholder="Enter lobby name" required>

        <label for="new-lobby-max-players">Max Players:</label>
        <select id="new-lobby-max-players">
            <option value="2">2 Players</option>
            <option value="3">3 Players</option>
            <option value="4">4 Players</option>
        </select>

        <div class="modal-buttons">
            <button class="primary-btn" onclick="confirmCreateLobby()">Create</button>
            <button class="primary-btn" onclick="closeCreateLobbyModal()">Cancel</button>
        </div>
    </div>
</div>

<script>
    // Global game state variables
    let currentUser = null;
    let userId = null; // Client-side generated ID for anonymous users, or username for registered
    let currentLobbyType = ''; // '4v4-qna', '1v1-fill-in-blanks', 'solo-coding-challenge'
    let currentLobbyId = '';

    // In-memory "database" for user credentials (NO PERSISTENCE)
    // Stores { username: { password: "password", soloStage: 0, correctAnswers: 0, totalAnswers: 0, elo: 0, id: "uniqueId" } }
    const users = {};
    let nextUserId = 1; // Simple counter for unique user IDs

    // In-memory "database" for active lobbies (NO PERSISTENCE)
    const activeLobbies = {}; // Stores { lobbyId: { id: "...", name: "...", type: "...", players: [], maxPlayers: N, gameStarted: false, chatMessages: [] } }

    let players = []; // Local array of players in the current lobby
    let isPlayerReady = false; // Current user's ready status in the current lobby

    // Game variables for Q&A / Fill-in-the-blanks modes
    let questions = [];
    let currentQuestionIndex = 0;
    let currentPlayerIndex = 0;
    let timeLeft = 30;
    let timer;

    // Solo Challenge variables
    let currentSoloStage = 0; // Index for soloChallenges array - will be loaded from user data

    // API Key for Gemini.
    // WARNING: For a production application, you should use a backend server to proxy requests
    // to the Gemini API to keep your API key secure.
    const API_KEY = "AIzaSyA5NgYegSNZz95wbNtCKI9GnloXKCczQAw"; // Keep empty as per instructions, will be provided by Canvas runtime.
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;


    const originalQuestions = [
        { q: "What is the output of: cout << 2 + 2;", a: "4" },
        { q: "Which keyword is used for constant?", a: "const" },
        { q: "How many bytes is an int?", a: "4" },
        { q: "C++ pointer access operator?", a: "->" },
        { q: "Declare a pointer to int", a: "int* ptr;" }
    ];

    const fillInBlanksQuestions = [
        { q: "int main() { cout << \"Hello, ___\"; return 0; }", a: "world", hint: "Common greeting" },
        { q: "int ___ = 10;", a: "x", hint: "A common variable name" },
        { q: "for (int i = 0; i < ___; i++)", a: "10", hint: "A typical loop limit" },
        { q: "class MyClass { public: MyClass() { /* constructor */ } };", a: "MyClass", hint: "Name of the class" },
        { q: "std::string ___ = \"C++\";", a: "language", hint: "What is C++?" }
    ];

    // Solo Coding Challenges
    const soloChallenges = [
        {
            stage: 1,
            title: "Hello World!",
            problem: "Write a C++ program that prints 'Hello, World!' to the console. The output must exactly match 'Hello, World!' followed by a newline.",
            expectedOutput: "Hello, World!\n",
            initialCode: `#include <iostream>

int main() {
    // Your code here
    return 0;
}`
        },
        {
            stage: 2,
            title: "Add Two Numbers",
            problem: "Write a C++ program that declares two integer variables, `a` and `b`, initializes them to 5 and 7 respectively, and prints their sum to the console. The output must be exactly '12' followed by a newline.",
            expectedOutput: "12\n",
            initialCode: `#include <iostream>

int main() {
    int a = 5;
    int b = 7;
    // Your code here
    std::cout << (a + b) << std::endl;
    return 0;
}`
        },
        {
            stage: 3,
            title: "Conditional Statement"
            // ... (rest of your soloChallenges array)
        }
    ];


    // Function to show a custom modal alert
    function showAlert(title, message) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = message;
        document.getElementById('customModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('customModal').style.display = 'none';
    }

    // --- Authentication Functions ---
    let isLoginMode = true; // Track if currently in login or signup mode

    function toggleAuthMode() {
        isLoginMode = !isLoginMode;
        document.getElementById('authTitle').innerText = isLoginMode ? 'Login' : 'Sign Up';
        document.getElementById('authSubmitBtn').innerText = isLoginMode ? 'Login' : 'Sign Up';
        document.getElementById('authSwitch').innerText = isLoginMode ? "Don't have an account? Sign Up" : "Already have an account? Login";
    }

    function authAction() {
        const username = document.getElementById('usernameInput').value;
        const password = document.getElementById('passwordInput').value;

        if (!username || !password) {
            showAlert('Error', 'Please enter both username and password.');
            return;
        }

        if (isLoginMode) {
            // Login logic
            if (users[username] && users[username].password === password) {
                currentUser = username;
                userId = users[username].id; // Set userId from registered user
                showModeSelection();
                document.getElementById('welcomeMessage').innerText = `Welcome, ${currentUser}!`;
                document.getElementById('welcomeMessage').style.display = 'block';
                document.getElementById('logoutBtn').style.display = 'block';
            } else {
                showAlert('Login Failed', 'Invalid username or password.');
            }
        } else {
            // Sign Up logic
            if (users[username]) {
                showAlert('Sign Up Failed', 'Username already exists. Please choose a different one.');
            } else {
                users[username] = {
                    password: password,
                    soloStage: 0,
                    correctAnswers: 0,
                    totalAnswers: 0,
                    elo: 1000, // Starting ELO
                    id: `user_${nextUserId++}` // Assign a unique ID
                };
                showAlert('Success', 'Account created! Please log in.');
                toggleAuthMode(); // Switch back to login mode after signup
            }
        }
    }

    function logout() {
        currentUser = null;
        userId = null;
        document.getElementById('authContainer').style.display = 'flex';
        document.getElementById('gameModeSelection').style.display = 'none';
        document.getElementById('lobbyListContainer').style.display = 'none';
        document.getElementById('singleLobbyView').style.display = 'none';
        document.getElementById('gameUI').style.display = 'none';
        document.getElementById('soloChallengeUI').style.display = 'none';
        document.getElementById('mainContentWrapper').style.display = 'none'; // Ensure wrapper is hidden
        document.getElementById('welcomeMessage').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'none';
        // Clear inputs
        document.getElementById('usernameInput').value = '';
        document.getElementById('passwordInput').value = '';
    }

    // --- UI Navigation Functions ---
    function showModeSelection() {
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('gameModeSelection').style.display = 'flex';
        document.getElementById('mainContentWrapper').style.display = 'none'; // Ensure main wrapper is hidden
        document.getElementById('lobbyListContainer').style.display = 'none';
        document.getElementById('singleLobbyView').style.display = 'none';
        document.getElementById('gameUI').style.display = 'none';
        document.getElementById('soloChallengeUI').style.display = 'none';
        document.getElementById('chatBox').style.display = 'none';
    }

    function backToModeSelection() {
        currentLobbyType = ''; // Clear selected lobby type
        showModeSelection();
    }

    function showLobbyList(mode) {
        currentLobbyType = mode;
        document.getElementById('gameModeSelection').style.display = 'none';
        document.getElementById('lobbyListContainer').style.display = 'flex';
        document.getElementById('lobbyListTitle').innerText = `Available Lobbies - ${mode === '4v4-qna' ? '4v4 Q&A' : '1v1 Fill in the Blanks'}`;
        renderLobbies();
    }

    function backToLobbiesList() {
        document.getElementById('singleLobbyView').style.display = 'none';
        document.getElementById('lobbyListContainer').style.display = 'flex';
        currentLobbyId = ''; // Clear current lobby ID
        isPlayerReady = false; // Reset ready status
        document.getElementById('readyToggleBtn').innerText = 'Ready Up!'; // Reset button text
        document.getElementById('readyToggleBtn').classList.remove('ready-btn', 'not-ready-btn'); // Remove specific classes
        renderLobbies(); // Refresh lobby list
    }

    function showGameUI() {
        document.getElementById('gameModeSelection').style.display = 'none';
        document.getElementById('lobbyListContainer').style.display = 'none';
        document.getElementById('singleLobbyView').style.display = 'none';
        document.getElementById('soloChallengeUI').style.display = 'none';

        document.getElementById('mainContentWrapper').style.display = 'flex'; // Show main wrapper
        document.getElementById('gameUI').style.display = 'flex';
        document.getElementById('chatBox').style.display = 'flex'; // Show chat box for multiplayer
    }

    function selectGameMode(mode) {
        currentLobbyType = mode;
        if (mode === 'solo-coding-challenge') {
            showSoloChallengeUI();
        } else {
            // For multiplayer modes, go to lobby list first
            showLobbyList(mode);
        }
    }

    function showSoloChallengeUI() {
        document.getElementById('gameModeSelection').style.display = 'none';
        document.getElementById('lobbyListContainer').style.display = 'none';
        document.getElementById('singleLobbyView').style.display = 'none';
        document.getElementById('gameUI').style.display = 'none';
        document.getElementById('chatBox').style.display = 'none'; // Hide chat for solo mode

        document.getElementById('mainContentWrapper').style.display = 'flex';
        document.getElementById('soloChallengeUI').style.display = 'flex';

        // Load user's last solo stage
        currentSoloStage = users[currentUser] ? users[currentUser].soloStage : 0;
        loadSoloChallenge();
    }


    // --- Lobby Management Functions ---

    function generateLobbyId() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function createNewLobby() {
        document.getElementById('createLobbyModal').style.display = 'flex';
    }

    function closeCreateLobbyModal() {
        document.getElementById('createLobbyModal').style.display = 'none';
        document.getElementById('new-lobby-name').value = '';
        document.getElementById('new-lobby-max-players').value = '2';
    }

    function confirmCreateLobby() {
        const lobbyName = document.getElementById('new-lobby-name').value.trim();
        const maxPlayers = parseInt(document.getElementById('new-lobby-max-players').value);

        if (!lobbyName) {
            showAlert('Error', 'Please enter a lobby name.');
            return;
        }

        const newLobbyId = generateLobbyId();
        const currentPlayer = { name: currentUser, id: userId, ready: false }; // Current user is automatically in the lobby

        activeLobbies[newLobbyId] = {
            id: newLobbyId,
            name: lobbyName,
            type: currentLobbyType,
            players: [currentPlayer],
            maxPlayers: maxPlayers,
            gameStarted: false,
            chatMessages: [] // Initialize chat for the lobby
        };

        currentLobbyId = newLobbyId; // Set the newly created lobby as the current one
        closeCreateLobbyModal();
        joinLobby(newLobbyId); // Automatically join and display the new lobby
        showAlert('Lobby Created', `Lobby "${lobbyName}" created! ID: ${newLobbyId}`);
    }


    function renderLobbies() {
        const lobbiesGrid = document.getElementById('lobbiesGrid');
        lobbiesGrid.innerHTML = ''; // Clear existing lobbies

        const availableLobbies = Object.values(activeLobbies).filter(lobby => lobby.type === currentLobbyType);

        if (availableLobbies.length === 0) {
            lobbiesGrid.innerHTML = '<p>No lobbies available. Be the first to create one!</p>';
            return;
        }

        availableLobbies.forEach(lobby => {
            const lobbyCard = document.createElement('div');
            lobbyCard.classList.add('lobby-card');
            if (lobby.players.length >= lobby.maxPlayers) {
                lobbyCard.classList.add('full');
            }

            lobbyCard.innerHTML = `
                <h3>${lobby.name} <span style="font-size: 0.8em; opacity: 0.7;">(ID: ${lobby.id})</span></h3>
                <p>Players: ${lobby.players.length}/${lobby.maxPlayers}</p>
                <p>Status: ${lobby.gameStarted ? 'In Game' : 'Waiting'}</p>
                <button class="join-btn" data-lobby-id="${lobby.id}" ${lobby.players.length >= lobby.maxPlayers || lobby.gameStarted ? 'disabled' : ''}>Join</button>
            `;
            lobbyCard.querySelector('.join-btn').onclick = () => joinLobby(lobby.id);
            lobbiesGrid.appendChild(lobbyCard);
        });
    }

    function joinLobby(lobbyId) {
        const lobby = activeLobbies[lobbyId];
        if (!lobby) {
            showAlert('Error', 'Lobby not found!');
            renderLobbies(); // Refresh the list in case it was removed
            return;
        }

        if (lobby.players.length >= lobby.maxPlayers) {
            showAlert('Full Lobby', 'This lobby is full!');
            renderLobbies();
            return;
        }

        if (lobby.gameStarted) {
            showAlert('Game Started', 'This game has already started!');
            renderLobbies();
            return;
        }

        // Check if the current user is already in this lobby
        const existingPlayer = lobby.players.find(p => p.id === userId);
        if (!existingPlayer) {
            // Add current user to the lobby
            lobby.players.push({ name: currentUser, id: userId, ready: false });
        } else {
            // If user rejoins, make sure their ready status is reflected from the lobby state
            isPlayerReady = existingPlayer.ready;
        }

        currentLobbyId = lobbyId; // Set the current lobby ID
        showSingleLobbyView(lobbyId);
    }


    function showSingleLobbyView(lobbyId) {
        document.getElementById('lobbyListContainer').style.display = 'none';
        document.getElementById('singleLobbyView').style.display = 'flex';

        const lobby = activeLobbies[lobbyId];
        if (!lobby) {
            showAlert('Error', 'Lobby data missing for single view.');
            backToLobbiesList();
            return;
        }

        document.getElementById('currentLobbyTitle').innerText = lobby.name;
        document.getElementById('displayLobbyId').innerText = lobby.id;
        document.getElementById('displayMaxPlayers').innerText = lobby.maxPlayers;
        document.getElementById('displayLobbyStatus').innerText = lobby.gameStarted ? 'In Game' : 'Waiting';

        updateLobbyPlayersDisplay(lobby);
        updateReadyButtonState();
        updateStartGameButtonState(); // Check if Start Game should be enabled
    }

    function updateLobbyPlayersDisplay(lobby) {
        const lobbyPlayersDisplay = document.getElementById('lobbyPlayersDisplay');
        lobbyPlayersDisplay.innerHTML = '';

        lobby.players.forEach(player => {
            const playerCard = document.createElement('div');
            playerCard.classList.add('lobby-card'); // Reuse lobby-card styling for player display
            playerCard.style.cursor = 'default'; // No pointer for player cards
            playerCard.style.minHeight = 'auto'; // Adjust height
            playerCard.style.padding = '15px';


            const statusSpan = `<span class="player-status ${player.ready ? 'ready' : 'not-ready'}">
                                    ${player.ready ? 'READY' : 'NOT READY'}
                                </span>`;

            playerCard.innerHTML = `
                <h3>${player.name}</h3>
                <p>ID: ${player.id}</p>
                <p>Status: ${statusSpan}</p>
            `;
            lobbyPlayersDisplay.appendChild(playerCard);
        });

        // Update player count
        document.getElementById('displayPlayerCount').innerText = lobby.players.length;
    }

    function toggleReady() {
        if (!currentLobbyId || !currentUser) return;

        const lobby = activeLobbies[currentLobbyId];
        if (lobby) {
            const player = lobby.players.find(p => p.id === userId);
            if (player) {
                player.ready = !player.ready;
                isPlayerReady = player.ready; // Update local state
                updateReadyButtonState();
                updateLobbyPlayersDisplay(lobby); // Refresh player list
                updateStartGameButtonState(); // Re-evaluate start game button
                // In a real app, you'd send this "ready" status to the server
                showAlert('Ready Status', `You are now ${isPlayerReady ? 'READY' : 'NOT READY'}.`);
            }
        }
    }

    function updateReadyButtonState() {
        const readyButton = document.getElementById('readyToggleBtn');
        if (isPlayerReady) {
            readyButton.innerText = 'Unready';
            readyButton.classList.remove('not-ready-btn');
            readyButton.classList.add('ready-btn');
        } else {
            readyButton.innerText = 'Ready Up!';
            readyButton.classList.remove('ready-btn');
            readyButton.classList.add('not-ready-btn');
        }
    }

    function updateStartGameButtonState() {
        const startGameButton = document.getElementById('startGameButton');
        const lobby = activeLobbies[currentLobbyId];

        if (!lobby) {
            startGameButton.disabled = true;
            return;
        }

        // Only the first player (host) can start the game in this basic implementation
        const isHost = lobby.players[0] && lobby.players[0].id === userId;
        const allPlayersReady = lobby.players.length > 0 && lobby.players.every(p => p.ready);
        const hasMinPlayers = lobby.players.length >= 2; // Example: require at least 2 players

        startGameButton.disabled = !(isHost && allPlayersReady && hasMinPlayers);

        if (isHost && allPlayersReady && hasMinPlayers) {
            startGameButton.title = "All players are ready! Click to start.";
        } else if (isHost) {
            let tooltip = "You are the host. ";
            if (!hasMinPlayers) tooltip += "Need at least 2 players. ";
            if (!allPlayersReady) tooltip += "Waiting for all players to be ready.";
            startGameButton.title = tooltip;
        } else {
            startGameButton.title = "Only the host can start the game when all players are ready.";
        }
    }


    function startGame() {
        if (!currentLobbyId || !currentUser) {
            showAlert('Error', 'No active lobby or user.');
            return;
        }

        const lobby = activeLobbies[currentLobbyId];
        if (!lobby) {
            showAlert('Error', 'Lobby not found to start game.');
            return;
        }

        // Basic host check (first player in the lobby)
        const isHost = lobby.players[0] && lobby.players[0].id === userId;
        if (!isHost) {
            showAlert('Permission Denied', 'Only the lobby host can start the game.');
            return;
        }

        // Check if all players are ready and there are enough players
        const allPlayersReady = lobby.players.length > 0 && lobby.players.every(p => p.ready);
        const hasMinPlayers = lobby.players.length >= 2;

        if (!hasMinPlayers) {
            showAlert('Cannot Start', 'Need at least 2 players to start the game.');
            return;
        }

        if (!allPlayersReady) {
            showAlert('Cannot Start', 'Not all players are ready.');
            return;
        }

        lobby.gameStarted = true;
        showAlert('Game Started!', 'The game is commencing!');
        showGameUI();
        initGame(); // Initialize the game UI and logic
    }


    function leaveLobby() {
        if (!currentLobbyId || !currentUser) return;

        const lobby = activeLobbies[currentLobbyId];
        if (lobby) {
            // Remove current user from the lobby's player list
            lobby.players = lobby.players.filter(p => p.id !== userId);

            // If the lobby becomes empty, delete it (or mark for cleanup)
            if (lobby.players.length === 0) {
                delete activeLobbies[currentLobbyId];
                console.log(`Lobby ${currentLobbyId} deleted as it's empty.`);
            } else {
                // If the host leaves, assign a new host (first player in the updated list)
                // In a real app, this would involve more sophisticated host migration logic
                if (lobby.gameStarted) {
                    showAlert('Game Interrupted', 'The host left the game. Lobby disbanded.');
                    delete activeLobbies[currentLobbyId]; // Force close if game was running
                }
                console.log(`Player ${currentUser} left lobby ${currentLobbyId}.`);
            }
        }
        currentLobbyId = '';
        isPlayerReady = false; // Reset ready status
        backToLobbiesList(); // Return to the lobby list
    }

    // --- In-Game Functions (Q&A / Fill-in-the-blanks) ---

    function initGame() {
        // Determine which set of questions to use based on currentLobbyType
        questions = currentLobbyType === '4v4-qna' ? [...originalQuestions] : [...fillInBlanksQuestions];
        // Shuffle questions
        questions.sort(() => Math.random() - 0.5);

        // Initialize players for the game UI (copy from lobby players)
        // Ensure player objects have 'lives', 'score', 'accuracy', etc.
        players = activeLobbies[currentLobbyId].players.map(p => ({
            name: p.name,
            id: p.id,
            lives: 3, // Example: starting lives
            score: 0,
            correctAnswers: users[p.name]?.correctAnswers || 0, // Load from user data
            totalAnswers: users[p.name]?.totalAnswers || 0, // Load from user data
            elo: users[p.name]?.elo || 1000 // Load ELO
        }));

        currentQuestionIndex = 0;
        currentPlayerIndex = 0; // Start with the first player
        renderPlayers();
        nextQuestion();
        updateLeaderboard();
        updateGlobalLeaderboard(); // Show global leaderboard during game too
    }

    function renderPlayers() {
        const playerCircle = document.getElementById('playerCircle');
        playerCircle.innerHTML = '';
        const numPlayers = players.length;
        const radius = playerCircle.offsetWidth / 2 - 50; // Adjust radius for player box size

        players.forEach((player, index) => {
            const angle = (360 / numPlayers) * index;
            const x = radius * Math.cos(angle * Math.PI / 180);
            const y = radius * Math.sin(angle * Math.PI / 180);

            const playerDiv = document.createElement('div');
            playerDiv.classList.add('player');
            playerDiv.style.left = `calc(50% + ${x}px)`;
            playerDiv.style.top = `calc(50% + ${y}px)`;

            playerDiv.innerHTML = `
                <div class="name" id="player-${player.id}">${player.name}</div>
                <div class="lives">Lives: ${player.lives}</div>
            `;
            playerCircle.appendChild(playerDiv);
        });
    }

    function nextQuestion() {
        clearTimeout(timer); // Clear any existing timer

        if (currentQuestionIndex >= questions.length) {
            endGame();
            return;
        }

        const questionData = questions[currentQuestionIndex];
        document.getElementById('question').innerText = questionData.q;
        document.getElementById('answerInput').value = '';
        document.getElementById('answerInput').focus();

        // Highlight current player
        players.forEach(p => document.getElementById(`player-${p.id}`).classList.remove('active', 'correct', 'wrong'));
        const currentPlayerElement = document.getElementById(`player-${players[currentPlayerIndex].id}`);
        if (currentPlayerElement) {
            currentPlayerElement.classList.add('active');
        }

        timeLeft = 30;
        document.getElementById('timer').innerText = timeLeft;
        timer = setInterval(countdown, 1000);
    }

    function countdown() {
        timeLeft--;
        document.getElementById('timer').innerText = timeLeft;
        if (timeLeft <= 0) {
            clearInterval(timer);
            showAlert('Time Up!', `${players[currentPlayerIndex].name} ran out of time!`);
            handleIncorrectAnswer();
        }
    }

    function submitAnswer() {
        clearInterval(timer);
        const userAnswer = document.getElementById('answerInput').value.trim();
        const correctAnswer = questions[currentQuestionIndex].a;
        const currentPlayer = players[currentPlayerIndex];

        // Update user's total answers for overall accuracy tracking
        if (users[currentUser]) {
            users[currentUser].totalAnswers++;
        }


        if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
            showAlert('Correct!', 'Your answer is correct!');
            currentPlayer.score += 100; // Example score
            if (users[currentUser]) {
                users[currentUser].correctAnswers++; // Update user's correct answers
            }
            document.getElementById(`player-${currentPlayer.id}`).classList.add('correct');
        } else {
            showAlert('Incorrect!', `Wrong answer! The correct answer was "${correctAnswer}".`);
            handleIncorrectAnswer();
            document.getElementById(`player-${currentPlayer.id}`).classList.add('wrong');
        }
        updateLeaderboard();
        updateGlobalLeaderboard();

        // Move to next player
        currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
        currentQuestionIndex++;
        setTimeout(nextQuestion, 2000); // Wait 2 seconds before next question
    }

    function handleIncorrectAnswer() {
        const currentPlayer = players[currentPlayerIndex];
        currentPlayer.lives--;
        if (currentPlayer.lives <= 0) {
            showAlert('Eliminated!', `${currentPlayer.name} has been eliminated!`);
            players = players.filter(p => p.id !== currentPlayer.id); // Remove eliminated player
            renderPlayers(); // Re-render players
            if (players.length <= 1) { // If only one or no players left
                endGame();
                return;
            }
            // Adjust currentPlayerIndex if the current player was removed and it was the last one
            if (currentPlayerIndex >= players.length) {
                currentPlayerIndex = 0;
            }
        }
    }

    function endGame() {
        clearInterval(timer);
        showAlert('Game Over!', 'The game has ended!');
        document.getElementById('questionBox').style.display = 'none';
        document.getElementById('timer').style.display = 'none';
        document.getElementById('replayButton').style.display = 'block';

        // Update ELO for all participating players
        // This is a simplified ELO update for demonstration
        const winner = players.length > 0 ? players[0] : null;

        players.forEach(player => {
            if (users[player.name]) {
                // For simplicity, just increase ELO for winners and decrease for others
                // A proper ELO system would involve pairwise comparisons and K-factors
                if (winner && player.id === winner.id) {
                    users[player.name].elo += 10; // Winner gains ELO
                } else {
                    users[player.name].elo -= 5; // Losers lose ELO
                }
                users[player.name].elo = Math.max(0, users[player.name].elo); // Ensure ELO doesn't go below 0
            }
        });

        updateLeaderboard(); // Final update
        updateGlobalLeaderboard();
    }

    function replayGame() {
        document.getElementById('questionBox').style.display = 'block';
        document.getElementById('timer').style.display = 'block';
        document.getElementById('replayButton').style.display = 'none';
        initGame();
    }

    function updateLeaderboard() {
        const leaderboardBody = document.getElementById('leaderboardBody');
        leaderboardBody.innerHTML = '';

        // Sort players by score, then lives
        const sortedPlayers = [...players].sort((a, b) => {
            if (b.score !== a.score) return b.score - a.score;
            return b.lives - a.lives;
        });

        sortedPlayers.forEach((player, index) => {
            const row = leaderboardBody.insertRow();
            row.insertCell().innerText = index + 1;
            row.insertCell().innerText = player.name;
            row.insertCell().innerText = users[player.name] ? users[player.name].elo : 'N/A';
            const accuracy = player.totalAnswers > 0 ? ((player.correctAnswers / player.totalAnswers) * 100).toFixed(0) : 0;
            row.insertCell().innerText = `${accuracy}%`;
        });
    }

    function updateGlobalLeaderboard() {
        const globalLeaderboardBody = document.getElementById('globalLeaderboardBody');
        globalLeaderboardBody.innerHTML = '';

        // Convert users object to an array and sort by ELO
        const allUsers = Object.values(users);
        const sortedGlobalUsers = [...allUsers].sort((a, b) => b.elo - a.elo);

        sortedGlobalUsers.forEach((user, index) => {
            const row = globalLeaderboardBody.insertRow();
            row.insertCell().innerText = index + 1;
            row.insertCell().innerText = Object.keys(users).find(key => users[key] === user); // Get username
            row.insertCell().innerText = user.elo;
            const accuracy = user.totalAnswers > 0 ? ((user.correctAnswers / user.totalAnswers) * 100).toFixed(0) : 0;
            row.insertCell().innerText = `${accuracy}%`;
        });
    }

    // --- Solo Challenge Functions ---
    async function loadSoloChallenge() {
        const stageData = soloChallenges[currentSoloStage];
        if (stageData) {
            document.getElementById('soloCurrentStage').innerText = stageData.stage;
            document.getElementById('soloProblemDescription').innerText = stageData.problem;
            document.getElementById('soloCodeEditor').value = stageData.initialCode;
            document.getElementById('soloResult').innerText = ''; // Clear previous result

            // Update navigation buttons
            document.getElementById('soloPrevStageBtn').disabled = currentSoloStage === 0;
            document.getElementById('soloNextStageBtn').disabled = currentSoloStage >= soloChallenges.length - 1;
        } else {
            document.getElementById('soloProblemDescription').innerText = "Congratulations! You've completed all solo challenges!";
            document.getElementById('soloCodeEditor').value = '';
            document.getElementById('soloCodeEditor').disabled = true;
            document.getElementById('soloChallengeButtons').style.display = 'none';
        }
    }

    function previousSoloStage() {
        if (currentSoloStage > 0) {
            currentSoloStage--;
            loadSoloChallenge();
        }
    }

    function nextSoloStage() {
        if (currentSoloStage < soloChallenges.length - 1) {
            currentSoloStage++;
            loadSoloChallenge();
        }
    }

    async function submitSoloCode() {
        const code = document.getElementById('soloCodeEditor').value;
        const stageData = soloChallenges[currentSoloStage];
        const soloResultDiv = document.getElementById('soloResult');
        const loadingIndicator = document.getElementById('soloLoadingIndicator');

        if (!stageData) {
            soloResultDiv.innerText = "No challenge loaded.";
            return;
        }

        loadingIndicator.style.display = 'block';
        soloResultDiv.innerText = '';

        const requestBody = {
            contents: [
                {
                    parts: [
                        { text: `Evaluate the following C++ code for correctness based on the given problem. Compile and run the code. Provide the standard output. If there's a compilation error or runtime error, report it. Then, compare the actual output with the expected output. Finally, provide a verdict: "PASSED" if output matches, "FAILED" if it doesn't, or "ERROR" if compilation/runtime issues. Include only the verdict at the very end.\n\nProblem:\n${stageData.problem}\n\nExpected Output:\n\`\`\`\n${stageData.expectedOutput}\`\`\`\n\nC++ Code:\n\`\`\`cpp\n${code}\`\`\`\n\nProvide the compilation status, then the output, then the final verdict.` }
                    ]
                }
            ]
        };

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('API Error:', errorData);
                soloResultDiv.innerText = `API Error: ${errorData.error.message || 'Unknown error'}`;
                loadingIndicator.style.display = 'none';
                return;
            }

            const data = await response.json();
            const resultText = data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts[0] ? data.candidates[0].content.parts[0].text : 'No response from API.';
            
            soloResultDiv.innerText = resultText;

            // Check for PASSED/FAILED/ERROR verdict from the API response
            const verdictMatch = resultText.match(/(PASSED|FAILED|ERROR)$/m);
            const verdict = verdictMatch ? verdictMatch[1] : '';

            if (verdict === 'PASSED') {
                showAlert('Challenge Passed!', 'Great job! Moving to the next stage.');
                // Update user's solo stage
                if (users[currentUser]) {
                    users[currentUser].soloStage = currentSoloStage + 1;
                }
                setTimeout(nextSoloStage, 1500); // Auto-advance to next stage
            } else if (verdict === 'FAILED') {
                showAlert('Challenge Failed', 'Your code produced an incorrect output. Please review your code.');
            } else if (verdict === 'ERROR') {
                 showAlert('Code Error', 'Your code had a compilation or runtime error. Please fix it.');
            } else {
                showAlert('Evaluation Incomplete', 'Could not determine exact verdict. Check the output.');
            }

        } catch (error) {
            console.error('Fetch error:', error);
            soloResultDiv.innerText = `An error occurred: ${error.message}. Please try again.`;
            showAlert('Network Error', 'Could not connect to the evaluation service.');
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }


    function leaveSoloChallenge() {
        document.getElementById('mainContentWrapper').style.display = 'none';
        showModeSelection();
    }


    // --- Chat Functions ---
    function sendMessage() {
        const chatInput = document.getElementById('chatInput');
        const message = chatInput.value.trim();

        if (message && currentLobbyId) {
            const lobby = activeLobbies[currentLobbyId];
            if (lobby) {
                lobby.chatMessages.push({ sender: currentUser, text: message, timestamp: new Date().toLocaleTimeString() });
                renderChatMessages();
                chatInput.value = '';
            }
        }
    }

    function renderChatMessages() {
        const chatMessagesDiv = document.getElementById('chatMessages');
        chatMessagesDiv.innerHTML = ''; // Clear existing messages

        if (currentLobbyId) {
            const lobby = activeLobbies[currentLobbyId];
            if (lobby) {
                lobby.chatMessages.forEach(msg => {
                    const msgElement = document.createElement('p');
                    msgElement.innerHTML = `[${msg.timestamp}] <strong>${msg.sender}</strong>: ${msg.text}`;
                    chatMessagesDiv.appendChild(msgElement);
                });
                // Scroll to the bottom
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
            }
        }
    }


    // Initial setup when page loads
    document.addEventListener('DOMContentLoaded', () => {
        // Initially show auth container
        document.getElementById('authContainer').style.display = 'flex';

        // Bind Enter key to authAction in login/signup form
        document.getElementById('usernameInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                document.getElementById('passwordInput').focus();
            }
        });
        document.getElementById('passwordInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                authAction();
            }
        });

        // Bind Enter key to sendMessage in chat input
        document.getElementById('chatInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        // Bind Enter key to submitAnswer in game question input
        document.getElementById('answerInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                submitAnswer();
            }
        });
    });

</script>
</body>
</html>
