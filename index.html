<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Code Rivals - C++ Challenge</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    body {
        margin: 0;
        padding: 0;
        background: radial-gradient(circle at center, #001f3f, #000);
        font-family: 'Orbitron', sans-serif;
        color: #00ccff;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh; /* Use min-height for content adaptability */
        width: 100vw;
        overflow-x: hidden; /* Prevent horizontal scroll */
        overflow-y: auto; /* Allow vertical scroll for content */
        font-family: 'Inter', sans-serif; /* Use Inter for general text */
    }

    h1 {
        text-shadow: 0 0 10px #00ccff;
        margin: 20px 0 10px;
        font-size: 32px;
        font-family: 'Orbitron', sans-serif; /* Keep Orbitron for titles */
    }

    .game-container {
        position: relative;
        width: 90%; /* Responsive width */
        max-width: 900px; /* Increased max width */
        height: 650px; /* Increased height */
        border: 2px solid #00ccff;
        border-radius: 20px;
        box-shadow: 0 0 30px #00ccff inset;
        background-color: rgba(0, 0, 50, 0.9);
        overflow: hidden;
        margin-top: 10px;
    }

    /* Shared button style for back button */
    #backToLobbyBtn, #soloBackToLobbyBtn, .back-to-mode-selection-btn, .back-to-lobbies-btn {
        position: absolute;
        padding: 8px 16px;
        background-color: #001f3f;
        border: 2px solid #00ccff;
        color: #00ccff;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 10px #00ccff;
        z-index: 10;
        border-radius: 8px;
        top: 10px;
        left: 10px; /* Positioned on the left side */
        transition: transform 0.2s, box-shadow 0.2s;
    }
    #backToLobbyBtn:hover, #soloBackToLobbyBtn:hover, .back-to-mode-selection-btn:hover, .back-to-lobbies-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 15px #00ff00;
    }


    .player-circle {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }

    .player {
        position: absolute;
        width: 100px;
        text-align: center;
        transform: translate(-50%, -50%);
    }

    .player .name {
        font-weight: bold;
        font-size: 16px;
    }

    .player .name.active {
        color: yellow;
        text-shadow: 0 0 10px yellow;
    }

    .player .name.correct {
        color: lime;
        text-shadow: 0 0 10px lime;
    }

    .player .name.wrong {
        color: red;
        text-shadow: 0 0 10px red;
    }

    .player .lives {
        font-size: 12px;
    }

    #timer {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 48px;
        text-shadow: 0 0 10px #00ccff;
    }

    #questionBox {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0,0,50,0.7);
        padding: 20px;
        border: 2px solid #00ccff;
        border-radius: 10px;
        box-shadow: 0 0 10px #00ccff;
        width: 90%; /* Responsive width */
        max-width: 700px; /* Max width for question box */
        text-align: center;
        box-sizing: border-box; /* Include padding in width */
    }

    #questionBox input[type="text"] {
        padding: 10px;
        font-size: 16px;
        width: calc(70% - 15px); /* Adjusted width */
        background-color: black;
        color: #00ccff;
        border: 1px solid #00ccff;
        border-radius: 5px;
        margin-right: 10px;
        box-sizing: border-box;
    }

    #questionBox button {
        padding: 10px 20px;
        background-color: #001f3f;
        border: 2px solid #00ccff;
        color: #00ccff;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 10px #00ccff;
        border-radius: 5px;
        transition: background-color 0.2s, box-shadow 0.2s;
    }
    #questionBox button:hover {
        background-color: #003f6f;
        box-shadow: 0 0 15px #00ff00;
    }

    .replay-button {
        margin-top: 20px;
        display: none;
    }

    #leaderboard, #globalLeaderboard {
        margin-top: 20px;
        width: 95%; /* Expanded width */
        max-width: 900px;
        background-color: rgba(0,0,0,0.85);
        border: 3px solid #00ccff;
        border-radius: 20px;
        padding: 10px;
        color: #00ccff;
        font-size: 14px;
        font-weight: bold;
        text-align: center;
        box-shadow: 0 0 15px #00ccff;
        height: auto;
        margin-bottom: 20px; /* Added margin */
    }

    #leaderboard table, #globalLeaderboard table {
        width: 100%;
        border-collapse: collapse;
        font-family: 'Orbitron', sans-serif;
    }

    #leaderboard th, #leaderboard td, #globalLeaderboard th, #globalLeaderboard td {
        padding: 12px 10px;
        border: 1px solid #00ccff;
    }

    #leaderboard thead, #globalLeaderboard thead {
        background-color: #000;
        color: #00ccff;
        font-size: 18px;
        text-shadow: 0 0 5px #00ccff;
    }

    #leaderboard tbody tr:nth-child(odd), #globalLeaderboard tbody tr:nth-child(odd) {
        background-color: rgba(0, 0, 50, 0.6);
    }

    #leaderboard tbody tr:nth-child(even), #globalLeaderboard tbody tr:nth-child(even) {
        background-color: rgba(0, 0, 100, 0.4);
    }

    #leaderboard tbody td, #globalLeaderboard tbody td {
        font-size: 16px;
    }

    /* Styles for Game Mode Selection */
    #gameModeSelection {
        display: none; /* Hidden by default, shown after login */
        flex-direction: column; /* Changed to column for better mobile layout */
        align-items: center;
        background-color: rgba(0,0,50,0.9);
        border: 2px solid #00ccff;
        border-radius: 20px;
        padding: 20px;
        width: 90%;
        max-width: 600px;
        text-align: center;
        box-shadow: 0 0 20px #00ccff;
        margin-top: 50px;
        gap: 20px;
    }

    .game-mode-box {
        width: 100%; /* Full width within container */
        background-color: #001f3f;
        border: 2px solid #00ccff;
        border-radius: 15px;
        padding: 30px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .game-mode-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 0 25px #00ccff;
    }

    .game-mode-box h3 {
        margin-top: 0;
        color: #00ccff;
        text-shadow: 0 0 8px #00ccff;
        font-family: 'Orbitron', sans-serif;
    }

    #gameUI {
        display: none;
        flex-direction: column;
        align-items: center;
        margin-top: 10px;
        flex-grow: 1;
    }

    /* New styles for chat box */
    .main-content-wrapper {
        display: none;
        flex-direction: row; /* Default to row for wider screens */
        gap: 20px;
        width: 95%; /* Adjust width to fit content */
        max-width: 1200px; /* Max width for the wrapper */
        justify-content: center;
        align-items: stretch;
        flex-grow: 1;
        min-height: 80vh; /* Occupy significant vertical space */
        flex-wrap: wrap; /* Allow wrapping for smaller screens */
    }
    @media (max-width: 992px) { /* Adjust for tablet/mobile */
        .main-content-wrapper {
            flex-direction: column; /* Stack vertically on smaller screens */
            align-items: center;
        }
        .game-container, #chatBox, #soloChallengeUI {
            width: 95%; /* Wider on smaller screens */
            max-width: 650px; /* Adjust max-width */
        }
    }


    #chatBox {
        background-color: rgba(0, 0, 50, 0.9);
        border: 2px solid #00ccff;
        border-radius: 10px;
        box-shadow: 0 0 20px #00ccff;
        width: 300px; /* Fixed width for chat */
        height: auto; /* Allow height to adjust */
        min-height: 300px; /* Minimum height for chat box */
        margin-top: 10px;
        padding: 15px;
        display: flex;
        flex-direction: column;
    }

    #chatMessages {
        flex-grow: 1;
        overflow-y: auto;
        border: 1px solid #00ccff;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
        background-color: rgba(0, 0, 0, 0.5);
        color: #00ccff;
        font-size: 14px;
        word-wrap: break-word;
        min-height: 150px; /* Ensure chat messages area has min height */
    }

    #chatInput {
        padding: 8px;
        font-size: 14px;
        background-color: black;
        color: #00ccff;
        border: 1px solid #00ccff;
        border-radius: 5px;
        width: calc(100% - 16px);
        margin-bottom: 5px;
    }

    #sendChatBtn {
        padding: 8px 15px;
        background-color: #001f3f;
        border: 2px solid #00ccff;
        color: #00ccff;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 10px #00ccff;
        border-radius: 5px;
        width: 100%;
        transition: background-color 0.2s, box-shadow 0.2s;
    }
    #sendChatBtn:hover {
        background-color: #003f6f;
        box-shadow: 0 0 15px #00ff00;
    }

    /* Solo Challenge UI Styles */
    #soloChallengeUI {
        display: none;
        flex-direction: column;
        align-items: center;
        background-color: rgba(0,0,50,0.9);
        border: 2px solid #00ccff;
        border-radius: 20px;
        box-shadow: 0 0 30px #00ccff inset;
        padding: 20px;
        width: 90%; /* Responsive width */
        max-width: 900px; /* Same max-width as game-container for consistency */
        min-height: 650px; /* Adjusted min-height for content */
        margin-top: 10px;
        position: relative;
        flex-grow: 1;
        box-sizing: border-box;
    }

    #soloChallengeUI h2 {
        color: #00ccff;
        text-shadow: 0 0 8px #00ccff;
        margin-top: 0;
        font-family: 'Orbitron', sans-serif;
    }

    #soloProblemDescription {
        background-color: rgba(0,0,0,0.7);
        border: 1px solid #00ccff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        width: calc(100% - 30px);
        min-height: 80px;
        overflow-y: auto;
        font-size: 16px;
        box-sizing: border-box;
    }

    #soloCodeEditor {
        width: calc(100% - 20px);
        height: 200px;
        background-color: #000;
        color: #00ff00; /* Green text for code editor */
        border: 1px solid #00ccff;
        border-radius: 5px;
        padding: 10px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        resize: vertical;
        margin-bottom: 15px;
        box-sizing: border-box;
    }

    #soloChallengeButtons {
        display: flex;
        flex-wrap: wrap; /* Allow buttons to wrap */
        justify-content: center;
        gap: 15px;
        margin-bottom: 15px;
    }

    #soloChallengeButtons button {
        padding: 12px 25px;
        background-color: #001f3f;
        border: 2px solid #00ccff;
        color: #00ccff;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 10px #00ccff;
        border-radius: 8px;
        transition: background-color 0.2s, box-shadow 0.2s;
    }

    #soloChallengeButtons button:hover:not(:disabled) {
        background-color: #003f6f;
        box-shadow: 0 0 15px #00ff00;
    }

    #soloChallengeButtons button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }

    #soloLoadingIndicator {
        display: none;
        text-align: center;
        margin-top: 10px;
        font-size: 18px;
        color: yellow;
    }

    #soloResult {
        background-color: rgba(0,0,0,0.7);
        border: 1px solid #00ccff;
        border-radius: 8px;
        padding: 15px;
        width: calc(100% - 30px);
        min-height: 80px;
        overflow-y: auto;
        font-size: 14px;
        white-space: pre-wrap;
        box-sizing: border-box;
    }


    /* Custom Modal for Alerts */
    .custom-modal {
        display: none;
        position: fixed;
        z-index: 20;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .custom-modal-content {
        background-color: rgba(0,0,50,0.95);
        margin: auto;
        padding: 30px;
        border: 3px solid #00ccff;
        border-radius: 15px;
        width: 90%; /* Responsive width */
        max-width: 400px;
        text-align: center;
        box-shadow: 0 0 25px #00ccff;
        transform: scale(0.95);
        animation: modalFadeIn 0.3s forwards;
        color: #fff;
    }

    .custom-modal-content h3 {
        color: #00ccff;
        text-shadow: 0 0 10px #00ccff;
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 24px;
        font-family: 'Orbitron', sans-serif;
    }

    .custom-modal-content p {
        font-size: 16px;
        margin-bottom: 25px;
        line-height: 1.5;
    }

    .custom-modal-content button {
        background-color: #001f3f;
        border: 2px solid #00ccff;
        color: #00ccff;
        padding: 10px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 0 10px #00ccff;
        transition: background-color 0.2s, box-shadow 0.2s;
    }

    .custom-modal-content button:hover {
        background-color: #003f6f;
        box-shadow: 0 0 15px #00ff00;
    }

    @keyframes modalFadeIn {
        from { opacity: 0; transform: scale(0.8); }
        to { opacity: 1; transform: scale(1); }
    }

    /* Login/Signup Forms */
    #authContainer {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: rgba(0,0,50,0.9);
        border: 2px solid #00ccff;
        border-radius: 20px;
        padding: 30px;
        width: 90%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 0 25px #00ccff;
        margin-top: 50px;
    }

    #authContainer h2 {
        color: #00ccff;
        text-shadow: 0 0 8px #00ccff;
        margin-top: 0;
        margin-bottom: 25px;
        font-family: 'Orbitron', sans-serif;
    }

    #authContainer input[type="text"],
    #authContainer input[type="password"] {
        width: calc(100% - 20px);
        padding: 12px;
        margin-bottom: 15px;
        background-color: black;
        color: #00ccff;
        border: 1px solid #00ccff;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box;
    }

    #authContainer button {
        width: 100%;
        padding: 12px;
        background-color: #001f3f;
        border: 2px solid #00ccff;
        color: #00ccff;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 10px #00ccff;
        border-radius: 8px;
        font-size: 18px;
        transition: background-color 0.2s, box-shadow 0.2s;
        margin-bottom: 10px;
    }

    #authContainer button:hover {
        background-color: #003f6f;
        box-shadow: 0 0 15px #00ff00;
    }

    #authSwitch {
        color: #00ccff;
        text-decoration: underline;
        cursor: pointer;
        font-size: 14px;
        margin-top: 15px;
        transition: color 0.2s;
    }
    #authSwitch:hover {
        color: #00ff00;
    }

    /* Logout Button in Main UI (will be shown after login) */
    #logoutBtn {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 8px 16px;
        background-color: #a00000;
        border: 2px solid #ff0000;
        color: #fff;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 10px #ff0000;
        z-index: 10;
        border-radius: 8px;
        display: none;
        transition: background-color 0.2s, box-shadow 0.2s;
    }
    #logoutBtn:hover {
        background-color: #cc0000;
        box-shadow: 0 0 15px #ff6666;
    }

    #welcomeMessage {
        color: #fff;
        font-size: 18px;
        margin-top: 10px;
        display: none;
        text-align: center;
        margin-bottom: 20px;
    }

    /* New Lobby Styles */
    .lobby-list-container {
        display: none;
        flex-direction: column;
        align-items: center;
        background-color: rgba(0,0,50,0.9);
        border: 2px solid #00ccff;
        border-radius: 20px;
        padding: 20px;
        width: 90%;
        max-width: 800px;
        text-align: center;
        box-shadow: 0 0 20px #00ccff;
        margin-top: 50px;
        overflow-y: auto;
        max-height: 80vh;
    }

    .lobby-list-container h2 {
        color: #00ccff;
        text-shadow: 0 0 8px #00ccff;
        margin-top: 0;
        margin-bottom: 20px;
        font-family: 'Orbitron', sans-serif;
    }

    .lobby-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        width: 100%;
        padding: 10px;
    }

    .lobby-card {
        background-color: #001f3f;
        border: 2px solid #00ccff;
        border-radius: 15px;
        padding: 20px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        text-align: left;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 120px; /* Adjusted to min-height */
    }

    .lobby-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0 25px #00ccff;
    }

    .lobby-card h3 {
        margin: 0 0 10px 0;
        color: #00ccff;
        text-shadow: 0 0 5px #00ccff;
        font-size: 1.2em;
    }

    .lobby-card p {
        margin: 5px 0;
        font-size: 0.9em;
    }

    .lobby-card .join-btn {
        padding: 8px 15px;
        background-color: #004d40;
        border: 2px solid #00ccff;
        color: #00ccff;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 10px #00ccff;
        border-radius: 8px;
        transition: background-color 0.2s, box-shadow 0.2s;
        margin-top: 10px;
        align-self: flex-end;
    }

    .lobby-card .join-btn:hover {
        background-color: #00645a;
        box-shadow: 0 0 15px #00ff00;
    }

    .lobby-card.full {
        opacity: 0.7;
        cursor: not-allowed;
        background-color: #333;
    }

    .lobby-card.full .join-btn {
        background-color: #666;
        border-color: #999;
        cursor: not-allowed;
        box-shadow: none;
    }

    .lobby-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        margin-bottom: 20px;
        flex-wrap: wrap; /* Allow wrap for title and buttons */
    }

    .lobby-header button {
        position: relative;
        top: auto;
        left: auto;
        margin-right: 10px;
        margin-bottom: 10px; /* Space when wrapped */
    }
    .lobby-header h2 {
        flex-grow: 1; /* Allow title to take available space */
        text-align: center;
        margin-bottom: 10px;
    }

    #startGameButton {
        padding: 12px 25px;
        background-color: #008000;
        border: 2px solid #00ff00;
        color: #fff;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 10px #00ff00;
        border-radius: 8px;
        transition: background-color 0.2s, box-shadow 0.2s;
        margin-top: 20px;
    }

    #startGameButton:hover:not(:disabled) {
        background-color: #00b300;
        box-shadow: 0 0 15px #00ff00;
    }

    #startGameButton:disabled {
        cursor: not-allowed;
        opacity: 0.5;
        background-color: #555;
        border-color: #888;
        box-shadow: none;
    }

    #currentLobbyInfo {
        margin-top: 10px;
        font-size: 1.1em;
        color: #fff;
        text-shadow: 0 0 5px #00ccff;
        display: none;
    }

    .player-status {
        font-size: 0.9em;
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 10px;
        margin-left: 10px;
    }

    .player-status.ready {
        background-color: #00ff00;
        color: #003300;
    }

    .player-status.not-ready {
        background-color: #ff0000;
        color: #330000;
    }

    /* Styles for the Create Lobby Modal */
    #createLobbyModal {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 20;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.8);
        justify-content: center;
        align-items: center;
    }

    #createLobbyModal .custom-modal-content {
        padding: 25px;
        max-width: 450px;
    }

    #createLobbyModal .custom-modal-content h3 {
        margin-bottom: 15px;
        font-size: 22px;
    }

    #createLobbyModal .custom-modal-content label {
        display: block;
        text-align: left;
        margin-bottom: 8px;
        color: #00ccff;
        font-size: 15px;
    }

    #createLobbyModal .custom-modal-content input[type="text"],
    #createLobbyModal .custom-modal-content select {
        width: calc(100% - 20px);
        padding: 10px;
        margin-bottom: 20px;
        background-color: black;
        color: #00ccff;
        border: 1px solid #00ccff;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box;
    }
    
    /* Specific styling for select dropdown arrow */
    #createLobbyModal .custom-modal-content select {
        appearance: none; /* Remove default browser arrow */
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url('data:image/svg+xml;utf8,<svg fill="%2300ccff" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
    }


    #createLobbyModal .custom-modal-content button {
        width: auto; /* Allow buttons to size based on content */
        min-width: 120px;
        margin: 0 10px; /* Spacing between buttons */
    }

    #createLobbyModal .modal-buttons {
        display: flex;
        justify-content: center;
        margin-top: 10px;
    }
</style>
</head>
<body>
<h1>Code Rivals</h1>

<button id="logoutBtn" onclick="logout()">Logout</button>
<div id="welcomeMessage"></div>

<div id="authContainer">
    <h2 id="authTitle">Login</h2>
    <input type="text" id="usernameInput" placeholder="Username" autocomplete="username">
    <input type="password" id="passwordInput" placeholder="Password" autocomplete="current-password">
    <button id="authSubmitBtn" onclick="authAction()">Login</button>
    <div id="authSwitch" onclick="toggleAuthMode()">Don't have an account? Sign Up</div>
</div>


<div id="gameModeSelection">
    <h2>Choose Your Game Mode</h2>
    <div class="game-mode-box" onclick="showLobbyList('4v4-qna')">
        <h3>4v4 Q&A</h3>
        <p>Compete with up to 4 players in a fast-paced Q&A challenge.</p>
    </div>
    <div class="game-mode-box" onclick="showLobbyList('1v1-fill-in-blanks')">
        <h3>1v1 Fill in the Blanks</h3>
        <p>A head-to-head battle, filling in missing code for C++ beginners.</p>
    </div>
    <div class="game-mode-box" onclick="selectGameMode('solo-coding-challenge')">
        <h3>Solo Coding Challenge</h3>
        <p>Improve your skills by solving C++ problems, evaluated by AI.</p>
    </div>
</div>

<div id="lobbyListContainer" class="lobby-list-container">
    <div class="lobby-header">
        <button class="back-to-mode-selection-btn" onclick="backToModeSelection()">Back to Mode Select</button>
        <h2 id="lobbyListTitle">Available Lobbies</h2>
        <button onclick="createNewLobby()">Create New Lobby</button>
    </div>
    <div id="lobbiesGrid" class="lobby-grid">
        </div>
</div>

<div id="singleLobbyView" class="lobby-list-container">
    <div class="lobby-header">
        <button class="back-to-lobbies-btn" onclick="leaveLobby()">Leave Lobby</button>
        <h2 id="currentLobbyTitle"></h2>
        <button id="readyToggleBtn" onclick="toggleReady()">Ready Up!</button>
    </div>
    <p id="currentLobbyInfo">Lobby ID: <span id="displayLobbyId"></span> | Players: <span id="displayPlayerCount">0</span>/<span id="displayMaxPlayers">0</span> | Status: <span id="displayLobbyStatus"></span></p>
    <div id="lobbyPlayersDisplay" class="lobby-grid">
        </div>
    <button id="startGameButton" onclick="startGame()" disabled>Start Game</button>
</div>


<div class="main-content-wrapper">
    <div id="gameUI">
        <div class="game-container">
            <button id="backToLobbyBtn" onclick="leaveGame()">Back to Lobbies</button>
            <div class="player-circle" id="playerCircle"></div>
            <div id="timer">30</div>
            <div id="questionBox">
                <p id="question">Loading...</p>
                <input type="text" id="answerInput" placeholder="Your answer here" />
                <button id="submitAnswerBtn" onclick="submitAnswer()">Submit</button>
            </div>
        </div>

        <div id="leaderboard">
            <h2>Current Round Leaderboard</h2>
            <table>
                <thead>
                    <tr><th>Rank</th><th>Player</th><th>ELO</th><th>Accuracy</th></tr>
                </thead>
                <tbody id="leaderboardBody"></tbody>
            </table>
        </div>

        <div id="globalLeaderboard">
            <h2>Global Leaderboard (All Players)</h2>
            <table>
                <thead>
                    <tr><th>Rank</th><th>Player</th><th>ELO</th><th>Accuracy</th></tr>
                </thead>
                <tbody id="globalLeaderboardBody"></tbody>
            </table>
        </div>
        <div class="replay-button" id="replayButton">
            <button onclick="replayGame()">Replay</button>
        </div>
    </div>

    <div id="soloChallengeUI">
        <button id="soloBackToLobbyBtn" onclick="leaveSoloChallenge()">Back to Mode Select</button>
        <h2>Solo Coding Challenge - Stage <span id="soloCurrentStage">1</span></h2>
        <div id="soloProblemDescription"></div>
        <textarea id="soloCodeEditor" placeholder="Write your C++ code here..."></textarea>
        <div id="soloChallengeButtons">
            <button id="soloPrevStageBtn" onclick="previousSoloStage()" disabled>Previous Stage</button>
            <button onclick="submitSoloCode()">Run Code</button>
            <button id="soloNextStageBtn" onclick="nextSoloStage()" disabled>Next Stage</button>
        </div>
        <div id="soloLoadingIndicator">Evaluating code...</div>
        <div id="soloResult"></div>
    </div>


    <div id="chatBox">
        <h3>Lobby Chat</h3>
        <div id="chatMessages"></div>
        <input type="text" id="chatInput" placeholder="Type your message..." />
        <button id="sendChatBtn" onclick="sendMessage()">Send</button>
    </div>
</div>

<div id="customModal" class="custom-modal">
    <div class="custom-modal-content">
        <h3 id="modalTitle"></h3>
        <p id="modalMessage"></p>
        <button onclick="closeModal()">OK</button>
    </div>
</div>

<div id="createLobbyModal" class="custom-modal">
    <div class="custom-modal-content">
        <h3>Create New Lobby</h3>
        <label for="new-lobby-name">Lobby Name:</label>
        <input type="text" id="new-lobby-name" placeholder="Enter lobby name" required>

        <label for="new-lobby-max-players">Max Players:</label>
        <select id="new-lobby-max-players">
            <option value="2">2 Players</option>
            <option value="3">3 Players</option>
            <option value="4">4 Players</option>
        </select>

        <div class="modal-buttons">
            <button onclick="confirmCreateLobby()">Create</button>
            <button onclick="closeCreateLobbyModal()">Cancel</button>
        </div>
    </div>
</div>

<script>
    // Global game state variables
    let currentUser = null;
    let userId = null; // Client-side generated ID for anonymous users, or username for registered
    let currentLobbyType = ''; // '4v4-qna', '1v1-fill-in-blanks', 'solo-coding-challenge'
    let currentLobbyId = '';

    // In-memory "database" for user credentials (NO PERSISTENCE)
    // Stores { username: { password: "password", soloStage: 0, correctAnswers: 0, totalAnswers: 0, elo: 0, id: "uniqueId" } }
    const users = {}; 
    let nextUserId = 1; // Simple counter for unique user IDs

    // In-memory "database" for active lobbies (NO PERSISTENCE)
    const activeLobbies = {}; // Stores { lobbyId: { id: "...", name: "...", type: "...", players: [], maxPlayers: N, gameStarted: false, chatMessages: [] } }

    let players = []; // Local array of players in the current lobby
    let isPlayerReady = false; // Current user's ready status in the current lobby

    // Game variables for Q&A / Fill-in-the-blanks modes
    let questions = [];
    let currentQuestionIndex = 0;
    let currentPlayerIndex = 0;
    let timeLeft = 30;
    let timer;

    // Solo Challenge variables
    let currentSoloStage = 0; // Index for soloChallenges array - will be loaded from user data

    // API Key for Gemini.
    // WARNING: For a production application, you should use a backend server to proxy requests
    // to the Gemini API to keep your API key secure.
    const API_KEY = ""; // Keep empty as per instructions, will be provided by Canvas runtime.
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;


    const originalQuestions = [
        { q: "What is the output of: cout << 2 + 2;", a: "4" },
        { q: "Which keyword is used for constant?", a: "const" },
        { q: "How many bytes is an int?", a: "4" },
        { q: "C++ pointer access operator?", a: "->" },
        { q: "Declare a pointer to int", a: "int* ptr;" }
    ];

    const fillInBlanksQuestions = [
        { q: "int main() { cout << \"Hello, ___\"; return 0; }", a: "world", hint: "Common greeting" },
        { q: "int ___ = 10;", a: "x", hint: "A common variable name" },
        { q: "for (int i = 0; i < ___; i++)", a: "10", hint: "A typical loop limit" },
        { q: "class MyClass { public: MyClass() { /* constructor */ } };", a: "MyClass", hint: "Name of the class" },
        { q: "std::string ___ = \"C++\";", a: "language", hint: "What is C++?" }
    ];

    // Solo Coding Challenges
    const soloChallenges = [
        {
            stage: 1,
            title: "Hello World!",
            problem: "Write a C++ program that prints 'Hello, World!' to the console. The output must exactly match 'Hello, World!' followed by a newline.",
            expectedOutput: "Hello, World!\n",
            initialCode: `#include <iostream>

int main() {
    // Your code here
    return 0;
}`
        },
        {
            stage: 2,
            title: "Add Two Numbers",
            problem: "Write a C++ program that declares two integer variables, `a` and `b`, initializes them to 5 and 7 respectively, and prints their sum to the console. The output must be exactly '12' followed by a newline.",
            expectedOutput: "12\n",
            initialCode: `#include <iostream>

int main() {
    int a = 5;
    int b = 7;
    // Your code here
    std::cout << (a + b) << std::endl;
    return 0;
}`
        },
        {
            stage: 3,
            title: "Conditional Statement (If-Else)",
            problem: "Write a C++ program that declares an integer variable `num` and initializes it to 10. If `num` is greater than 5, print 'Greater than 5'; otherwise, print 'Not greater than 5'. The output must be exactly 'Greater than 5' followed by a newline.",
            expectedOutput: "Greater than 5\n",
            initialCode: `#include <iostream>

int main() {
    int num = 10;
    // Your if-else statement here
    if (num > 5) {
        std::cout << "Greater than 5" << std::endl;
    } else {
        std::cout << "Not greater than 5" << std::endl;
    }
    return 0;
}`
        },
        {
            stage: 4,
            title: "Simple Loop (For loop)",
            problem: "Write a C++ program that uses a for loop to print numbers from 1 to 3, each on a new line. The output must be exactly '1\\n2\\n3\\n'.",
            expectedOutput: "1\n2\n3\n",
            initialCode: `#include <iostream>

int main() {
    // Your for loop here
    for (int i = 1; i <= 3; ++i) {
        std::cout << i << std::endl;
    }
    return 0;
}`
        },
        {
            stage: 5,
            title: "Basic Function",
            problem: "Write a C++ program with a function named `add` that takes two integers as parameters and returns their sum. In `main`, call `add` with 15 and 20 and print the result. The output must be exactly '35' followed by a newline.",
            expectedOutput: "35\n",
            initialCode: `#include <iostream>

// Your add function here
int add(int a, int b) {
    return a + b;
}

int main() {
    // Call your function and print the result
    std::cout << add(15, 20) << std::endl;
    return 0;
}`
        },
        {
            stage: 6,
            title: "Factorial Calculation",
            problem: "Write a C++ program to calculate the factorial of a number (e.g., 5). Print the result. The output must be exactly '120' followed by a newline. (Factorial of 5 is 5*4*3*2*1 = 120)",
            expectedOutput: "120\n",
            initialCode: `#include <iostream>

int main() {
    int n = 5;
    long long factorial = 1; // Use long long for larger factorials

    // Calculate factorial
    for (int i = 1; i <= n; ++i) {
        factorial *= i;
    }

    std::cout << factorial << std::endl;
    return 0;
}`
        },
        {
            stage: 7,
            title: "Array Sum",
            problem: "Write a C++ program that initializes an integer array with values {10, 20, 30}. Calculate the sum of its elements and print the sum. The output must be exactly '60' followed by a newline.",
            expectedOutput: "60\n",
            initialCode: `#include <iostream>
#include <vector>
#include <numeric> // For std::accumulate

int main() {
    std::vector<int> arr = {10, 20, 30};
    int sum = 0;

    // Calculate sum
    for (int x : arr) {
        sum += x;
    }

    std::cout << sum << std::endl;
    return 0;
}`
        }
        // Add more solo challenges here
    ];


    // --- Helper Functions (Provided by you, with some minor additions for new UI) ---
    function showSection(sectionId) {
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('gameModeSelection').style.display = 'none';
        document.getElementById('lobbyListContainer').style.display = 'none';
        document.getElementById('singleLobbyView').style.display = 'none';
        document.getElementById('gameUI').style.display = 'none';
        document.getElementById('soloChallengeUI').style.display = 'none';
        document.getElementById('chatBox').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'none';
        document.getElementById('welcomeMessage').style.display = 'none';
        document.querySelector('.main-content-wrapper').style.display = 'none'; // Hide wrapper by default

        if (currentUser) { // Only show logout and welcome if logged in
            document.getElementById('logoutBtn').style.display = 'block';
            document.getElementById('welcomeMessage').style.display = 'block';
            document.getElementById('welcomeMessage').textContent = `Welcome, ${currentUser.username}! ELO: ${currentUser.elo} | Accuracy: ${currentUser.accuracy}%`;
        }

        const section = document.getElementById(sectionId);
        if (section) {
            section.style.display = 'flex'; // Use flex for these sections for proper centering/layout
            if (sectionId === 'gameUI' || sectionId === 'soloChallengeUI') {
                document.querySelector('.main-content-wrapper').style.display = 'flex';
                document.getElementById('chatBox').style.display = 'flex'; // Show chat alongside game/solo UI
            }
        }
    }

    // Modal functions
    function showModal(title, message) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').textContent = message;
        document.getElementById('customModal').style.display = 'flex'; // Use flex to center
    }

    function closeModal() {
        document.getElementById('customModal').style.display = 'none';
    }

    // --- Authentication Functions ---
    let isLoginMode = true; // true for login, false for signup

    function toggleAuthMode() {
        isLoginMode = !isLoginMode;
        document.getElementById('authTitle').textContent = isLoginMode ? 'Login' : 'Sign Up';
        document.getElementById('authSubmitBtn').textContent = isLoginMode ? 'Login' : 'Sign Up';
        document.getElementById('authSwitch').textContent = isLoginMode ? "Don't have an account? Sign Up" : "Already have an account? Login";
    }

    function authAction() {
        const username = document.getElementById('usernameInput').value;
        const password = document.getElementById('passwordInput').value;

        if (!username || !password) {
            showModal('Input Error', 'Please enter both username and password.');
            return;
        }

        if (isLoginMode) {
            if (users[username] && users[username].password === password) {
                currentUser = users[username];
                userId = currentUser.id; // Set userId to the actual user ID
                showModal('Success', `Logged in as ${username}!`);
                showSection('gameModeSelection');
            } else {
                showModal('Login Failed', 'Invalid username or password.');
            }
        } else { // Sign Up Mode
            if (users[username]) {
                showModal('Sign Up Failed', 'Username already taken.');
            } else {
                const newUserId = `user_${nextUserId++}`;
                users[username] = {
                    id: newUserId,
                    username: username,
                    password: password,
                    soloStage: 0,
                    correctAnswers: 0,
                    totalAnswers: 0,
                    elo: 1000 // Starting ELO
                };
                currentUser = users[username];
                userId = currentUser.id; // Set userId for the new user
                showModal('Success', `Account created for ${username}! Please log in.`);
                isLoginMode = true; // Switch back to login after signup
                toggleAuthMode(); // Update UI for login mode
                document.getElementById('usernameInput').value = username; // Pre-fill username
                document.getElementById('passwordInput').value = ''; // Clear password
            }
        }
    }

    function logout() {
        currentUser = null;
        userId = null;
        currentLobbyType = '';
        currentLobbyId = '';
        players = [];
        isPlayerReady = false;
        clearInterval(timer); // Clear any running game timer
        showSection('authContainer');
        showModal('Logged Out', 'You have been successfully logged out.');
    }

    // --- Game Mode Selection ---
    function selectGameMode(mode) {
        currentLobbyType = mode;
        if (mode === 'solo-coding-challenge') {
            showSoloChallengeUI();
        } else {
            // Logic for multiplayer mode selection
            showModal('Game Mode', `You selected ${mode}. Not yet implemented for direct play.`);
            // showSection('lobbyListContainer'); // This would typically lead to lobby list
        }
    }

    // --- Lobby Management (New and Modified Functions) ---

    function showLobbyList(gameType) {
        if (!currentUser) {
            showModal('Access Denied', 'Please log in to view lobbies.');
            return;
        }
        currentLobbyType = gameType; // Set the game type for the lobby list
        document.getElementById('lobbyListTitle').textContent = `Available ${gameType} Lobbies`;
        refreshLobbyList();
        showSection('lobbyListContainer');
    }

    function refreshLobbyList() {
        const lobbiesGrid = document.getElementById('lobbiesGrid');
        lobbiesGrid.innerHTML = ''; // Clear existing lobbies

        const lobbiesForType = Object.values(activeLobbies).filter(
            lobby => lobby.type === currentLobbyType && !lobby.gameStarted
        );

        if (lobbiesForType.length === 0) {
            lobbiesGrid.innerHTML = '<p style="text-align: center; width: 100%; color: #aaa;">No active lobbies. Create one!</p>';
            return;
        }

        lobbiesForType.forEach(lobby => {
            const playerCount = lobby.players.length;
            const isFull = playerCount >= lobby.maxPlayers;
            const lobbyCard = document.createElement('div');
            lobbyCard.classList.add('lobby-card');
            if (isFull) {
                lobbyCard.classList.add('full');
            }
            lobbyCard.innerHTML = `
                <h3>${lobby.name}</h3>
                <p>ID: ${lobby.id}</p>
                <p>Players: ${playerCount}/${lobby.maxPlayers}</p>
                <p>Status: ${lobby.gameStarted ? 'In Game' : 'Waiting'}</p>
                <button class="join-btn" ${isFull ? 'disabled' : ''} onclick="joinLobby('${lobby.id}')">
                    ${isFull ? 'Full' : 'Join'}
                </button>
            `;
            lobbiesGrid.appendChild(lobbyCard);
        });
    }

    function createNewLobby() {
        if (!currentUser) {
            showModal('Error', 'You must be logged in to create a lobby.');
            return;
        }
        // Show the create lobby modal
        document.getElementById('createLobbyModal').style.display = 'flex';
        // Pre-fill max players based on lobby type
        const maxPlayersSelect = document.getElementById('new-lobby-max-players');
        if (currentLobbyType === '1v1-fill-in-blanks') {
            maxPlayersSelect.value = '2'; // Force 2 players for 1v1
            maxPlayersSelect.disabled = true;
        } else { // 4v4 Q&A
            maxPlayersSelect.value = '4'; // Default to 4
            maxPlayersSelect.disabled = false;
        }
    }

    function closeCreateLobbyModal() {
        document.getElementById('createLobbyModal').style.display = 'none';
        document.getElementById('new-lobby-name').value = ''; // Clear input
        document.getElementById('new-lobby-max-players').value = '4'; // Reset select
    }

    function confirmCreateLobby() {
        const lobbyName = document.getElementById('new-lobby-name').value.trim();
        const maxPlayers = parseInt(document.getElementById('new-lobby-max-players').value, 10);

        if (!lobbyName) {
            showModal('Error', 'Please enter a lobby name.');
            return;
        }

        if (maxPlayers < 2 || maxPlayers > 4 || isNaN(maxPlayers)) {
             showModal('Error', 'Max players must be between 2 and 4.');
             return;
        }
        
        // Generate a simple unique lobby ID (for in-memory example)
        const newLobbyId = `lobby_${Object.keys(activeLobbies).length + 1}`;
        activeLobbies[newLobbyId] = {
            id: newLobbyId,
            name: lobbyName,
            type: currentLobbyType,
            players: [], // No players initially
            maxPlayers: maxPlayers,
            gameStarted: false,
            chatMessages: []
        };
        closeCreateLobbyModal();
        showModal('Lobby Created!', `Lobby "${lobbyName}" created with ID: ${newLobbyId}`);
        joinLobby(newLobbyId); // Automatically join the newly created lobby
    }


    function joinLobby(lobbyId) {
        if (!currentUser) {
            showModal('Access Denied', 'Please log in to join a lobby.');
            return;
        }
        const lobby = activeLobbies[lobbyId];
        if (!lobby) {
            showModal('Error', 'Lobby not found.');
            return;
        }
        if (lobby.players.length >= lobby.maxPlayers) {
            showModal('Lobby Full', 'This lobby is already full.');
            return;
        }
        if (lobby.players.some(p => p.id === currentUser.id)) {
            showModal('Already Joined', 'You are already in this lobby.');
            currentLobbyId = lobbyId; // Ensure currentLobbyId is set even if already joined
            displaySingleLobby(lobby);
            return;
        }
        if (lobby.gameStarted) {
            showModal('Game In Progress', 'You cannot join a game that has already started.');
            return;
        }

        // Add current user to lobby players
        lobby.players.push({
            id: currentUser.id,
            username: currentUser.username,
            isReady: false,
            isHost: lobby.players.length === 0 // First player to join is the host
        });
        currentLobbyId = lobbyId; // Set current lobby
        isPlayerReady = false; // Reset ready status when joining new lobby
        showModal('Joined Lobby', `You have joined "${lobby.name}"!`);
        displaySingleLobby(lobby);
        updateStartGameButton(); // Update host's start game button
    }

    function leaveLobby() {
        if (currentLobbyId && currentUser) {
            const lobby = activeLobbies[currentLobbyId];
            if (lobby) {
                // Remove current user from lobby players
                lobby.players = lobby.players.filter(p => p.id !== currentUser.id);

                // If no players left, delete the lobby (in-memory specific)
                if (lobby.players.length === 0) {
                    delete activeLobbies[currentLobbyId];
                    console.log(`Lobby ${currentLobbyId} deleted.`);
                } else {
                    // If the host left, assign new host (first player in list)
                    if (!lobby.players.some(p => p.isHost)) {
                        lobby.players[0].isHost = true;
                        showModal('Host Change', `New host is ${lobby.players[0].username}.`);
                    }
                }
            }
        }
        currentLobbyId = '';
        players = []; // Clear local players array
        isPlayerReady = false; // Reset ready status
        showLobbyList(currentLobbyType); // Go back to lobby list
        refreshLobbyList(); // Refresh the list for other players
    }

    function displaySingleLobby(lobby) {
        document.getElementById('currentLobbyTitle').textContent = `Lobby: ${lobby.name}`;
        document.getElementById('displayLobbyId').textContent = lobby.id;
        document.getElementById('displayPlayerCount').textContent = lobby.players.length;
        document.getElementById('displayMaxPlayers').textContent = lobby.maxPlayers;
        document.getElementById('displayLobbyStatus').textContent = lobby.gameStarted ? 'In Game' : 'Waiting';

        const lobbyPlayersDisplay = document.getElementById('lobbyPlayersDisplay');
        lobbyPlayersDisplay.innerHTML = ''; // Clear existing players

        lobby.players.forEach(p => {
            const playerCard = document.createElement('div');
            playerCard.classList.add('lobby-card'); // Re-use lobby-card style for players
            playerCard.innerHTML = `
                <h4>${p.username} ${p.isHost ? '(Host)' : ''} <span class="player-status ${p.isReady ? 'ready' : 'not-ready'}">${p.isReady ? 'Ready' : 'Not Ready'}</span></h4>
            `;
            lobbyPlayersDisplay.appendChild(playerCard);
        });

        // Update Ready button text
        const readyToggleBtn = document.getElementById('readyToggleBtn');
        readyToggleBtn.textContent = isPlayerReady ? 'Unready' : 'Ready Up!';
        readyToggleBtn.style.backgroundColor = isPlayerReady ? '#ffa500' : '#001f3f'; // Orange for unready
        readyToggleBtn.style.borderColor = isPlayerReady ? '#ffaa00' : '#00ccff';

        updateStartGameButton(); // Enable/disable start game button for host
        showSection('singleLobbyView');
    }

    function toggleReady() {
        if (!currentUser || !currentLobbyId) return;

        const lobby = activeLobbies[currentLobbyId];
        if (!lobby) return;

        const playerInLobby = lobby.players.find(p => p.id === currentUser.id);
        if (playerInLobby) {
            playerInLobby.isReady = !playerInLobby.isReady;
            isPlayerReady = playerInLobby.isReady; // Update local state
            displaySingleLobby(lobby); // Re-render to show updated status
        }
        updateStartGameButton(); // Update host's start game button
    }

    function updateStartGameButton() {
        const startGameButton = document.getElementById('startGameButton');
        if (!currentUser || !currentLobbyId) {
            startGameButton.disabled = true;
            return;
        }

        const lobby = activeLobbies[currentLobbyId];
        if (!lobby) {
            startGameButton.disabled = true;
            return;
        }

        const isCurrentUserHost = lobby.players.find(p => p.id === currentUser.id && p.isHost);
        if (!isCurrentUserHost) {
            startGameButton.disabled = true;
            return;
        }

        const allPlayersReady = lobby.players.length > 0 && lobby.players.every(p => p.isReady);
        const minPlayersMet = lobby.players.length >= 2; // At least 2 players to start

        startGameButton.disabled = !(allPlayersReady && minPlayersMet);
    }


    function startGame() {
        if (!currentUser || !currentLobbyId) return;

        const lobby = activeLobbies[currentLobbyId];
        if (!lobby) return;

        const isCurrentUserHost = lobby.players.find(p => p.id === currentUser.id && p.isHost);
        if (!isCurrentUserHost) {
            showModal('Not Host', 'Only the host can start the game.');
            return;
        }

        const allPlayersReady = lobby.players.every(p => p.isReady);
        const minPlayersMet = lobby.players.length >= 2;

        if (!minPlayersMet) {
            showModal('Cannot Start', 'Need at least 2 players to start the game.');
            return;
        }

        if (!allPlayersReady) {
            showModal('Cannot Start', 'All players must be ready to start the game.');
            return;
        }

        lobby.gameStarted = true;
        showModal('Game Starting!', `The game in lobby "${lobby.name}" is about to begin!`);
        
        // This is where you would transition to the actual game UI
        // For this example, let's just go to a dummy game state for multiplayer
        if (currentLobbyType === '4v4-qna') {
             // In a real app, you'd load Q&A game logic
            showModal('Game Started', '4v4 Q&A game logic would start here!');
            // showGameUI(originalQuestions, lobby.players);
            showSection('gameUI'); // For demonstration, just show gameUI
            resetGame(); // Reset game state for multiplayer Q&A
        } else if (currentLobbyType === '1v1-fill-in-blanks') {
            // In a real app, you'd load Fill-in-the-blanks logic
            showModal('Game Started', '1v1 Fill-in-the-blanks game logic would start here!');
            // showGameUI(fillInBlanksQuestions, lobby.players);
            showSection('gameUI'); // For demonstration, just show gameUI
            resetGame(); // Reset game state for multiplayer fill-in-blanks
        }
    }


    // --- Game Logic (Existing from your code) ---
    function showGameUI(qns, initialPlayers) {
        questions = qns;
        players = initialPlayers.map(p => ({
            id: p.id,
            username: p.username,
            lives: 3, // Initial lives for each player
            elo: users[p.username].elo || 1000,
            accuracy: users[p.username].accuracy || 0,
            correctAnswers: users[p.username].correctAnswers || 0,
            totalAnswers: users[p.username].totalAnswers || 0
        }));
        currentQuestionIndex = 0;
        currentPlayerIndex = 0; // Start with the first player
        showSection('gameUI');
        resetGame();
        displayPlayerCircles(); // Ensure player circles are displayed
    }

    function resetGame() {
        timeLeft = 30;
        document.getElementById('answerInput').value = '';
        document.getElementById('replayButton').style.display = 'none';
        document.getElementById('submitAnswerBtn').disabled = false;
        clearInterval(timer); // Clear any existing timer

        // Reset player states for new game
        players.forEach(p => {
            p.lives = 3;
            // ELO and accuracy are persisted per user, not reset per game
        });
        displayPlayerCircles(); // Update player UI

        loadQuestion();
        startTimer();
    }

    function loadQuestion() {
        if (currentQuestionIndex < questions.length) {
            const q = questions[currentQuestionIndex];
            document.getElementById('question').textContent = q.q;
            document.getElementById('answerInput').value = ''; // Clear previous answer
            document.getElementById('answerInput').focus(); // Focus on input
            highlightCurrentPlayer(); // Highlight the current player
        } else {
            endGame();
        }
    }

    function startTimer() {
        clearInterval(timer);
        timer = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').textContent = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(timer);
                processAnswer(false); // Player ran out of time
            }
        }, 1000);
    }

    function submitAnswer() {
        clearInterval(timer);
        const userAnswer = document.getElementById('answerInput').value.trim();
        const correctAnswer = questions[currentQuestionIndex].a;
        const isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
        processAnswer(isCorrect);
    }

    function processAnswer(isCorrect) {
        const currentPlayer = players[currentPlayerIndex];

        // Update user's stats
        if (currentUser && currentUser.id === currentPlayer.id) {
            currentUser.totalAnswers++;
            if (isCorrect) {
                currentUser.correctAnswers++;
                // Simple ELO gain for correct answer
                currentUser.elo += 10;
            } else {
                // Simple ELO loss for incorrect answer
                currentUser.elo -= 5;
            }
            currentUser.accuracy = ((currentUser.correctAnswers / currentUser.totalAnswers) * 100).toFixed(2);
            // Update global welcome message
            document.getElementById('welcomeMessage').textContent = `Welcome, ${currentUser.username}! ELO: ${currentUser.elo} | Accuracy: ${currentUser.accuracy}%`;
        }

        // Update current player's local stats for display
        currentPlayer.totalAnswers = currentUser ? currentUser.totalAnswers : (currentPlayer.totalAnswers || 0) + 1;
        currentPlayer.correctAnswers = currentUser && isCorrect && currentUser.id === currentPlayer.id ? (currentUser.correctAnswers || 0) : (currentPlayer.correctAnswers || 0); // Update from currentUser if it's them
        currentPlayer.accuracy = currentUser ? currentUser.accuracy : ((currentPlayer.correctAnswers / currentPlayer.totalAnswers) * 100).toFixed(2);
        currentPlayer.elo = currentUser ? currentUser.elo : (currentPlayer.elo || 1000);

        if (!isCorrect) {
            currentPlayer.lives--;
        }

        // Update player circle status immediately
        const playerDiv = document.querySelector(`.player[data-player-id="${currentPlayer.id}"] .name`);
        if (playerDiv) {
            playerDiv.classList.remove('active', 'correct', 'wrong');
            playerDiv.classList.add(isCorrect ? 'correct' : 'wrong');
        }

        displayPlayerCircles(); // Update lives and status

        setTimeout(() => {
            if (playerDiv) {
                playerDiv.classList.remove('correct', 'wrong'); // Remove status after a short delay
            }
            currentQuestionIndex++;
            currentPlayerIndex = (currentPlayerIndex + 1) % players.length; // Next player
            loadQuestion();
            startTimer();
        }, 1500); // Short delay to show correct/wrong status
        updateLeaderboard();
    }

    function endGame() {
        showModal('Game Over', 'All questions answered or players eliminated!');
        document.getElementById('replayButton').style.display = 'block';
        document.getElementById('submitAnswerBtn').disabled = true;
        clearInterval(timer);
        updateGlobalLeaderboard(); // Show global leaderboard at the end of the game
    }

    function replayGame() {
        currentQuestionIndex = 0;
        currentPlayerIndex = 0;
        resetGame();
    }

    function leaveGame() {
        clearInterval(timer);
        // Clear game-specific variables
        questions = [];
        currentQuestionIndex = 0;
        currentPlayerIndex = 0;
        timeLeft = 30;
        players = []; // Clear players from local game instance

        // Go back to the single lobby view if there's a current lobby
        if (currentLobbyId) {
            const lobby = activeLobbies[currentLobbyId];
            if (lobby) {
                 lobby.gameStarted = false; // Reset lobby status
                 displaySingleLobby(lobby); // Go back to the lobby view
            } else {
                 showLobbyList(currentLobbyType); // If lobby somehow disappeared, go to list
            }
        } else {
            showLobbyList(currentLobbyType); // If no current lobby, go to main lobby list
        }
    }


    function displayPlayerCircles() {
        const playerCircle = document.getElementById('playerCircle');
        playerCircle.innerHTML = '';
        const centerX = 50;
        const centerY = 50;
        const radius = 250; // Radius for player circle arrangement

        // Filter out players with 0 lives if this is a knockout game
        const activePlayers = players.filter(p => p.lives > 0);
        const totalActivePlayers = activePlayers.length;

        if (totalActivePlayers === 0 && players.length > 0) {
            // All players eliminated, end game
            endGame();
            return;
        }

        activePlayers.forEach((player, index) => {
            const angle = (index / totalActivePlayers) * 2 * Math.PI;
            const x = centerX + radius * Math.cos(angle);
            const y = centerY + radius * Math.sin(angle);

            const playerDiv = document.createElement('div');
            playerDiv.classList.add('player');
            playerDiv.style.left = `${x}px`;
            playerDiv.style.top = `${y}px`;
            playerDiv.setAttribute('data-player-id', player.id); // For easy selection

            const nameSpan = document.createElement('span');
            nameSpan.classList.add('name');
            nameSpan.textContent = player.username;
            if (index === currentPlayerIndex % totalActivePlayers && player.lives > 0) { // Only highlight if still active
                nameSpan.classList.add('active');
            }

            const livesSpan = document.createElement('span');
            livesSpan.classList.add('lives');
            livesSpan.textContent = `Lives: ${player.lives}`;

            playerDiv.appendChild(nameSpan);
            playerDiv.appendChild(livesSpan);
            playerCircle.appendChild(playerDiv);
        });
    }


    function highlightCurrentPlayer() {
        // Remove 'active' from all players first
        document.querySelectorAll('.player .name').forEach(nameSpan => {
            nameSpan.classList.remove('active');
        });

        // Add 'active' to the current player's name
        const currentPlayerDiv = document.querySelector(`.player[data-player-id="${players[currentPlayerIndex].id}"] .name`);
        if (currentPlayerDiv) {
            currentPlayerDiv.classList.add('active');
        }
    }

    function updateLeaderboard() {
        const leaderboardBody = document.getElementById('leaderboardBody');
        leaderboardBody.innerHTML = '';

        // Sort players by correct answers (or some other metric for in-game leaderboard)
        const sortedPlayers = [...players].sort((a, b) => {
            const userA = users[a.username];
            const userB = users[b.username];
            // Sort by ELO primarily, then by correct answers
            if (userA && userB) {
                if (userA.elo !== userB.elo) {
                    return userB.elo - userA.elo;
                }
                return userB.correctAnswers - userA.correctAnswers;
            }
            return 0;
        });

        sortedPlayers.forEach((player, index) => {
            const userStats = users[player.username] || { elo: 1000, accuracy: 0 }; // Fallback
            const row = leaderboardBody.insertRow();
            row.insertCell(0).textContent = index + 1; // Rank
            row.insertCell(1).textContent = player.username;
            row.insertCell(2).textContent = userStats.elo; // Display actual ELO
            row.insertCell(3).textContent = `${userStats.accuracy}%`; // Display actual Accuracy
        });
    }

    function updateGlobalLeaderboard() {
        const globalLeaderboardBody = document.getElementById('globalLeaderboardBody');
        globalLeaderboardBody.innerHTML = '';

        // Convert users object to an array and sort
        const allUsers = Object.values(users);
        const sortedUsers = allUsers.sort((a, b) => b.elo - a.elo); // Sort by ELO

        sortedUsers.forEach((user, index) => {
            const row = globalLeaderboardBody.insertRow();
            row.insertCell(0).textContent = index + 1; // Rank
            row.insertCell(1).textContent = user.username;
            row.insertCell(2).textContent = user.elo;
            row.insertCell(3).textContent = `${user.accuracy}%`;
        });
    }

    // --- Solo Challenge Functions ---
    function showSoloChallengeUI() {
        if (!currentUser) {
            showModal('Access Denied', 'Please log in to start a solo challenge.');
            return;
        }
        currentSoloStage = currentUser.soloStage || 0; // Load user's last stage
        loadSoloChallenge(currentSoloStage);
        showSection('soloChallengeUI');
        document.getElementById('soloBackToLobbyBtn').style.display = 'block'; // Make sure back button is visible
    }

    function loadSoloChallenge(stageIndex) {
        if (stageIndex >= 0 && stageIndex < soloChallenges.length) {
            const challenge = soloChallenges[stageIndex];
            document.getElementById('soloCurrentStage').textContent = challenge.stage;
            document.getElementById('soloProblemDescription').innerHTML = `<p>${challenge.problem}</p>`;
            document.getElementById('soloCodeEditor').value = challenge.initialCode;
            document.getElementById('soloResult').textContent = ''; // Clear previous result
            document.getElementById('soloLoadingIndicator').style.display = 'none';

            // Enable/disable navigation buttons
            document.getElementById('soloPrevStageBtn').disabled = (stageIndex === 0);
            document.getElementById('soloNextStageBtn').disabled = (stageIndex >= soloChallenges.length - 1);
        } else {
            showModal('Solo Challenges Complete!', 'You have completed all available solo coding challenges!');
            document.getElementById('soloNextStageBtn').disabled = true;
        }
    }

    function previousSoloStage() {
        if (currentSoloStage > 0) {
            currentSoloStage--;
            currentUser.soloStage = currentSoloStage; // Update user's progress
            loadSoloChallenge(currentSoloStage);
        }
    }

    function nextSoloStage() {
        if (currentSoloStage < soloChallenges.length - 1) {
            currentSoloStage++;
            currentUser.soloStage = currentSoloStage; // Update user's progress
            loadSoloChallenge(currentSoloStage);
        } else {
            showModal('Congratulations!', 'You have completed all solo challenges!');
        }
    }

    async function submitSoloCode() {
        const code = document.getElementById('soloCodeEditor').value;
        const resultDiv = document.getElementById('soloResult');
        const loadingIndicator = document.getElementById('soloLoadingIndicator');
        const currentChallenge = soloChallenges[currentSoloStage];

        resultDiv.textContent = ''; // Clear previous results
        loadingIndicator.style.display = 'block';
        showModal('Running Code', 'Compiling and executing your C++ code. Please wait...');


        // Simulate code execution with AI validation
        try {
            const prompt = `You are a C++ code executor and validator. The user provides a C++ code snippet and an expected output. Your task is to simulate the compilation and execution of the code. Then, compare its simulated output with the expected output and provide a clear "PASS" or "FAIL" status. If it fails, explain why and show the expected vs. actual output. Also, report any simulated compilation errors or runtime errors.

C++ Code:
\`\`\`cpp
${code}
\`\`\`

Expected Output:
\`\`\`
${currentChallenge.expectedOutput.trim()}
\`\`\`

Simulate the execution and provide the result. Focus only on the output and comparison. Do not generate explanations if the code passes. If it fails, provide concise feedback.`;

            const requestBody = {
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }]
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error("API Error:", errorData);
                showModal('API Error', `Failed to get response from AI: ${errorData.error ? errorData.error.message : response.statusText}`);
                resultDiv.textContent = `Error: Failed to evaluate code. API status: ${response.status}`;
                loadingIndicator.style.display = 'none';
                return;
            }

            const data = await response.json();
            const aiResponseText = data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts[0] ? data.candidates[0].content.parts[0].text : 'No response from AI.';

            resultDiv.textContent = aiResponseText;
            loadingIndicator.style.display = 'none';
            closeModal(); // Close the "Running Code" modal

            if (aiResponseText.includes("PASS")) {
                showModal('Challenge Passed!', `Congratulations! You passed Stage ${currentChallenge.stage}.`);
                // Auto-advance to next stage if passed
                if (currentSoloStage < soloChallenges.length - 1) {
                    // Update user's solo stage progression
                    currentUser.soloStage = currentSoloStage + 1;
                    // setTimeout(() => nextSoloStage(), 2000); // Auto-advance after 2 seconds
                } else {
                    showModal('All Challenges Complete!', 'You have mastered all solo challenges!');
                }
            } else {
                showModal('Challenge Failed', 'Your code did not produce the expected output. Check the result for details.');
            }

        } catch (error) {
            console.error("Error submitting code:", error);
            resultDiv.textContent = `An error occurred: ${error.message}`;
            loadingIndicator.style.display = 'none';
            showModal('Error', `An unexpected error occurred while evaluating your code: ${error.message}`);
        }
    }


    function leaveSoloChallenge() {
        showSection('gameModeSelection');
    }

    // --- Chat Functions (Basic In-Memory) ---
    function sendMessage() {
        const chatInput = document.getElementById('chatInput');
        const message = chatInput.value.trim();
        if (message && currentUser && currentLobbyId) {
            const lobby = activeLobbies[currentLobbyId];
            if (lobby) {
                const chatMessage = {
                    sender: currentUser.username,
                    text: message,
                    timestamp: new Date().toLocaleTimeString()
                };
                lobby.chatMessages.push(chatMessage);
                displayChatMessages();
                chatInput.value = ''; // Clear input
            }
        }
    }

    function displayChatMessages() {
        const chatMessagesDiv = document.getElementById('chatMessages');
        chatMessagesDiv.innerHTML = '';
        if (currentLobbyId && activeLobbies[currentLobbyId]) {
            activeLobbies[currentLobbyId].chatMessages.forEach(msg => {
                const msgElement = document.createElement('p');
                msgElement.innerHTML = `<strong>[${msg.timestamp}] ${msg.sender}:</strong> ${msg.text}`;
                chatMessagesDiv.appendChild(msgElement);
            });
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Auto-scroll to bottom
        }
    }

    // Initial load: show authentication container
    document.addEventListener('DOMContentLoaded', () => {
        showSection('authContainer');
        // Initial refresh for lobbies (empty at start, but ready for logic)
        refreshLobbyList();
        // Set up interval to refresh lobby list and single lobby view if active
        setInterval(() => {
            if (document.getElementById('lobbyListContainer').style.display === 'flex') {
                refreshLobbyList();
            }
            if (document.getElementById('singleLobbyView').style.display === 'flex' && currentLobbyId) {
                const lobby = activeLobbies[currentLobbyId];
                if (lobby) {
                    displaySingleLobby(lobby);
                }
            }
            if (document.getElementById('chatBox').style.display === 'flex' && currentLobbyId) {
                 displayChatMessages(); // Refresh chat
            }
        }, 3000); // Refresh every 3 seconds (adjust as needed)

        // Allow pressing Enter to send chat message
        document.getElementById('chatInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
    });

</script>
</body>
</html>
